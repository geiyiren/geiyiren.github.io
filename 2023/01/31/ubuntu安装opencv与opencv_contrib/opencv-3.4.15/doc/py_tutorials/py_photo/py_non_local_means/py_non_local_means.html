<h1 id="Image-Denoising-tutorial-py-non-local-means"><a href="#Image-Denoising-tutorial-py-non-local-means" class="headerlink" title="Image Denoising {#tutorial_py_non_local_means}"></a>Image Denoising {#tutorial_py_non_local_means}</h1><h2 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h2><p>In this chapter,</p>
<ul>
<li>You will learn about Non-local Means Denoising algorithm to remove noise in the image.</li>
<li>You will see different functions like <strong>cv.fastNlMeansDenoising()</strong>,<br><strong>cv.fastNlMeansDenoisingColored()</strong> etc.</li>
</ul>
<h2 id="Theory"><a href="#Theory" class="headerlink" title="Theory"></a>Theory</h2><p>In earlier chapters, we have seen many image smoothing techniques like Gaussian Blurring, Median<br>Blurring etc and they were good to some extent in removing small quantities of noise. In those<br>techniques, we took a small neighbourhood around a pixel and did some operations like gaussian<br>weighted average, median of the values etc to replace the central element. In short, noise removal<br>at a pixel was local to its neighbourhood.</p>
<p>There is a property of noise. Noise is generally considered to be a random variable with zero mean.<br>Consider a noisy pixel, \f$p &#x3D; p_0 + n\f$ where \f$p_0\f$ is the true value of pixel and \f$n\f$ is the noise in<br>that pixel. You can take large number of same pixels (say \f$N\f$) from different images and computes<br>their average. Ideally, you should get \f$p &#x3D; p_0\f$ since mean of noise is zero.</p>
<p>You can verify it yourself by a simple setup. Hold a static camera to a certain location for a<br>couple of seconds. This will give you plenty of frames, or a lot of images of the same scene. Then<br>write a piece of code to find the average of all the frames in the video (This should be too simple<br>for you now ). Compare the final result and first frame. You can see reduction in noise.<br>Unfortunately this simple method is not robust to camera and scene motions. Also often there is only<br>one noisy image available.</p>
<p>So idea is simple, we need a set of similar images to average out the noise. Consider a small window<br>(say 5x5 window) in the image. Chance is large that the same patch may be somewhere else in the<br>image. Sometimes in a small neighbourhood around it. What about using these similar patches together<br>and find their average? For that particular window, that is fine. See an example image below:</p>
<p><img src="/images/nlm_patch.jpg" alt="image"></p>
<p>The blue patches in the image looks the similar. Green patches looks similar. So we take a pixel,<br>take small window around it, search for similar windows in the image, average all the windows and<br>replace the pixel with the result we got. This method is Non-Local Means Denoising. It takes more<br>time compared to blurring techniques we saw earlier, but its result is very good. More details and<br>online demo can be found at first link in additional resources.</p>
<p>For color images, image is converted to CIELAB colorspace and then it separately denoise L and AB<br>components.</p>
<h2 id="Image-Denoising-in-OpenCV"><a href="#Image-Denoising-in-OpenCV" class="headerlink" title="Image Denoising in OpenCV"></a>Image Denoising in OpenCV</h2><p>OpenCV provides four variations of this technique.</p>
<p>-#  <strong>cv.fastNlMeansDenoising()</strong> - works with a single grayscale images<br>2.  <strong>cv.fastNlMeansDenoisingColored()</strong> - works with a color image.<br>3.  <strong>cv.fastNlMeansDenoisingMulti()</strong> - works with image sequence captured in short period of time<br>    (grayscale images)<br>4.  <strong>cv.fastNlMeansDenoisingColoredMulti()</strong> - same as above, but for color images.</p>
<p>Common arguments are:<br>    -   h : parameter deciding filter strength. Higher h value removes noise better, but removes<br>        details of image also. (10 is ok)<br>    -   hForColorComponents : same as h, but for color images only. (normally same as h)<br>    -   templateWindowSize : should be odd. (recommended 7)<br>    -   searchWindowSize : should be odd. (recommended 21)</p>
<p>Please visit first link in additional resources for more details on these parameters.</p>
<p>We will demonstrate 2 and 3 here. Rest is left for you.</p>
<h3 id="1-cv-fastNlMeansDenoisingColored"><a href="#1-cv-fastNlMeansDenoisingColored" class="headerlink" title="1. cv.fastNlMeansDenoisingColored()"></a>1. cv.fastNlMeansDenoisingColored()</h3><p>As mentioned above it is used to remove noise from color images. (Noise is expected to be gaussian).<br>See the example below:<br>@code{.py}<br>import numpy as np<br>import cv2 as cv<br>from matplotlib import pyplot as plt</p>
<p>img &#x3D; cv.imread(‘die.png’)</p>
<p>dst &#x3D; cv.fastNlMeansDenoisingColored(img,None,10,10,7,21)</p>
<p>plt.subplot(121),plt.imshow(img)<br>plt.subplot(122),plt.imshow(dst)<br>plt.show()<br>@endcode<br>Below is a zoomed version of result. My input image has a gaussian noise of \f$\sigma &#x3D; 25\f$. See the<br>result:</p>
<p><img src="/images/nlm_result1.jpg" alt="image"></p>
<h3 id="2-cv-fastNlMeansDenoisingMulti"><a href="#2-cv-fastNlMeansDenoisingMulti" class="headerlink" title="2. cv.fastNlMeansDenoisingMulti()"></a>2. cv.fastNlMeansDenoisingMulti()</h3><p>Now we will apply the same method to a video. The first argument is the list of noisy frames. Second<br>argument imgToDenoiseIndex specifies which frame we need to denoise, for that we pass the index of<br>frame in our input list. Third is the temporalWindowSize which specifies the number of nearby frames<br>to be used for denoising. It should be odd. In that case, a total of temporalWindowSize frames are<br>used where central frame is the frame to be denoised. For example, you passed a list of 5 frames as<br>input. Let imgToDenoiseIndex &#x3D; 2 and temporalWindowSize &#x3D; 3. Then frame-1, frame-2 and frame-3 are<br>used to denoise frame-2. Let’s see an example.<br>@code{.py}<br>import numpy as np<br>import cv2 as cv<br>from matplotlib import pyplot as plt</p>
<p>cap &#x3D; cv.VideoCapture(‘vtest.avi’)</p>
<h1 id="create-a-list-of-first-5-frames"><a href="#create-a-list-of-first-5-frames" class="headerlink" title="create a list of first 5 frames"></a>create a list of first 5 frames</h1><p>img &#x3D; [cap.read()[1] for i in range(5)]</p>
<h1 id="convert-all-to-grayscale"><a href="#convert-all-to-grayscale" class="headerlink" title="convert all to grayscale"></a>convert all to grayscale</h1><p>gray &#x3D; [cv.cvtColor(i, cv.COLOR_BGR2GRAY) for i in img]</p>
<h1 id="convert-all-to-float64"><a href="#convert-all-to-float64" class="headerlink" title="convert all to float64"></a>convert all to float64</h1><p>gray &#x3D; [np.float64(i) for i in gray]</p>
<h1 id="create-a-noise-of-variance-25"><a href="#create-a-noise-of-variance-25" class="headerlink" title="create a noise of variance 25"></a>create a noise of variance 25</h1><p>noise &#x3D; np.random.randn(*gray[1].shape)*10</p>
<h1 id="Add-this-noise-to-images"><a href="#Add-this-noise-to-images" class="headerlink" title="Add this noise to images"></a>Add this noise to images</h1><p>noisy &#x3D; [i+noise for i in gray]</p>
<h1 id="Convert-back-to-uint8"><a href="#Convert-back-to-uint8" class="headerlink" title="Convert back to uint8"></a>Convert back to uint8</h1><p>noisy &#x3D; [np.uint8(np.clip(i,0,255)) for i in noisy]</p>
<h1 id="Denoise-3rd-frame-considering-all-the-5-frames"><a href="#Denoise-3rd-frame-considering-all-the-5-frames" class="headerlink" title="Denoise 3rd frame considering all the 5 frames"></a>Denoise 3rd frame considering all the 5 frames</h1><p>dst &#x3D; cv.fastNlMeansDenoisingMulti(noisy, 2, 5, None, 4, 7, 35)</p>
<p>plt.subplot(131),plt.imshow(gray[2],’gray’)<br>plt.subplot(132),plt.imshow(noisy[2],’gray’)<br>plt.subplot(133),plt.imshow(dst,’gray’)<br>plt.show()<br>@endcode<br>Below image shows a zoomed version of the result we got:</p>
<p><img src="/images/nlm_multi.jpg" alt="image"></p>
<p>It takes considerable amount of time for computation. In the result, first image is the original<br>frame, second is the noisy one, third is the denoised image.</p>
<h2 id="Additional-Resources"><a href="#Additional-Resources" class="headerlink" title="Additional Resources"></a>Additional Resources</h2><p>-#  <a href="http://www.ipol.im/pub/art/2011/bcm_nlm/">http://www.ipol.im/pub/art/2011/bcm_nlm/</a> (It has the details, online demo etc. Highly<br>    recommended to visit. Our test image is generated from this link)<br>2.  <a href="https://www.coursera.org/course/images">Online course at coursera</a> (First image taken from<br>    here)</p>
<h2 id="Exercises"><a href="#Exercises" class="headerlink" title="Exercises"></a>Exercises</h2>