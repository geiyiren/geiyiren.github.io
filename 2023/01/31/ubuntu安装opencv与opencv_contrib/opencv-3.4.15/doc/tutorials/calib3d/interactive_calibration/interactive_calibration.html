<h1 id="Interactive-camera-calibration-application-tutorial-interactive-calibration"><a href="#Interactive-camera-calibration-application-tutorial-interactive-calibration" class="headerlink" title="Interactive camera calibration application {#tutorial_interactive_calibration}"></a>Interactive camera calibration application {#tutorial_interactive_calibration}</h1><p>@prev_tutorial{tutorial_real_time_pose}</p>
<p>According to classical calibration technique user must collect all data first and when run @ref cv::calibrateCamera function<br>to obtain camera parameters. If average re-projection error is huge or if estimated parameters seems to be wrong, process of<br>selection or collecting data and starting of @ref cv::calibrateCamera repeats.</p>
<p>Interactive calibration process assumes that after each new data portion user can see results and errors estimation, also<br>he can delete last data portion and finally, when dataset for calibration is big enough starts process of auto data selection.</p>
<h2 id="Main-application-features"><a href="#Main-application-features" class="headerlink" title="Main application features"></a>Main application features</h2><p>The sample application will:</p>
<ul>
<li>Determine the distortion matrix and confidence interval for each element</li>
<li>Determine the camera matrix and confidence interval for each element</li>
<li>Take input from camera or video file</li>
<li>Read configuration from XML file</li>
<li>Save the results into XML file</li>
<li>Calculate re-projection error</li>
<li>Reject patterns views on sharp angles to prevent appear of ill-conditioned jacobian blocks</li>
<li>Auto switch calibration flags (fix aspect ratio and elements of distortion matrix if needed)</li>
<li>Auto detect when calibration is done by using several criteria</li>
<li>Auto capture of static patterns (user doesn’t need press any keys to capture frame, just don’t move pattern for a second)</li>
</ul>
<p>Supported patterns:</p>
<ul>
<li>Black-white chessboard</li>
<li>Asymmetrical circle pattern</li>
<li>Dual asymmetrical circle pattern</li>
<li>chAruco (chessboard with Aruco markers)</li>
</ul>
<h2 id="Description-of-parameters"><a href="#Description-of-parameters" class="headerlink" title="Description of parameters"></a>Description of parameters</h2><p>Application has two groups of parameters: primary (passed through command line) and advances (passed through XML file).</p>
<h3 id="Primary-parameters"><a href="#Primary-parameters" class="headerlink" title="Primary parameters:"></a>Primary parameters:</h3><p>All of this parameters are passed to application through a command line.</p>
<p>-[parameter]&#x3D;[default value]: description</p>
<ul>
<li>-v&#x3D;[filename]: get video from filename, default input – camera with id&#x3D;0</li>
<li>-ci&#x3D;[0]: get video from camera with specified id</li>
<li>-flip&#x3D;[false]: vertical flip of input frames</li>
<li>-t&#x3D;[circles]: pattern for calibration (circles, chessboard, dualCircles, chAruco)</li>
<li>-sz&#x3D;[16.3]: distance between two nearest centers of circles or squares on calibration board</li>
<li>-dst&#x3D;[295] distance between white and black parts of daulCircles pattern</li>
<li>-w&#x3D;[width]: width of pattern (in corners or circles)</li>
<li>-h&#x3D;[height]: height of pattern (in corners or circles)</li>
<li>-of&#x3D;[camParams.xml]: output file name</li>
<li>-ft&#x3D;[true]: auto tuning of calibration flags</li>
<li>-vis&#x3D;[grid]: captured boards visualization (grid, window)</li>
<li>-d&#x3D;[0.8]: delay between captures in seconds</li>
<li>-pf&#x3D;[defaultConfig.xml]: advanced application parameters file</li>
</ul>
<h3 id="Advanced-parameters"><a href="#Advanced-parameters" class="headerlink" title="Advanced parameters:"></a>Advanced parameters:</h3><p>By default values of advanced parameters are stored in defaultConfig.xml</p>
<p>@code{.xml}<br><?xml version="1.0"?><br><opencv_storage><br><charuco_dict>0</charuco_dict><br><charuco_square_length>200</charuco_square_length><br><charuco_marker_size>100</charuco_marker_size><br><calibration_step>1</calibration_step><br><max_frames_num>30</max_frames_num><br><min_frames_num>10</min_frames_num><br><solver_eps>1e-7</solver_eps><br><solver_max_iters>30</solver_max_iters><br><fast_solver>0</fast_solver><br><frame_filter_conv_param>0.1</frame_filter_conv_param><br><camera_resolution>1280 720</camera_resolution><br></opencv_storage><br>@endcode</p>
<ul>
<li><em>charuco_dict</em>: name of special dictionary, which has been used for generation of chAruco pattern</li>
<li><em>charuco_square_length</em>: size of square on chAruco board (in pixels)</li>
<li><em>charuco_marker_size</em>: size of Aruco markers on chAruco board (in pixels)</li>
<li><em>calibration_step</em>: interval in frames between launches of @ref cv::calibrateCamera</li>
<li><em>max_frames_num</em>: if number of frames for calibration is greater then this value frames filter starts working.<br>After filtration size of calibration dataset is equals to <em>max_frames_num</em></li>
<li><em>min_frames_num</em>: if number of frames is greater then this value turns on auto flags tuning, undistorted view and quality evaluation</li>
<li><em>solver_eps</em>: precision of Levenberg-Marquardt solver in @ref cv::calibrateCamera</li>
<li><em>solver_max_iters</em>: iterations limit of solver</li>
<li><em>fast_solver</em>: if this value is nonzero and Lapack is found QR decomposition is used instead of SVD in solver.<br>QR faster than SVD, but potentially less precise</li>
<li><em>frame_filter_conv_param</em>: parameter which used in linear convolution of bicriterial frames filter</li>
<li><em>camera_resolution</em>: resolution of camera which is used for calibration</li>
</ul>
<p><strong>Note:</strong> <em>charuco_dict</em>, <em>charuco_square_length</em> and <em>charuco_marker_size</em> are used for chAruco pattern generation<br>(see Aruco module description for details: <a href="https://github.com/opencv/opencv_contrib/tree/master/modules/aruco/tutorials">Aruco tutorials</a>)</p>
<p>Default chAruco pattern:</p>
<p><img src="/images/charuco_board.png"></p>
<h2 id="Dual-circles-pattern"><a href="#Dual-circles-pattern" class="headerlink" title="Dual circles pattern"></a>Dual circles pattern</h2><p>To make this pattern you need standard OpenCV circles pattern and binary inverted one.<br>Place two patterns on one plane in order when all horizontal lines of circles in one pattern are<br> continuations of similar lines in another.<br>Measure distance between patterns as shown at picture below pass it as <strong>dst</strong> command line parameter. Also measure distance between centers of nearest circles and pass<br>this value as <strong>sz</strong> command line parameter.</p>
<p><img src="/images/dualCircles.jpg"></p>
<p>This pattern is very sensitive to quality of production and measurements.</p>
<h2 id="Data-filtration"><a href="#Data-filtration" class="headerlink" title="Data filtration"></a>Data filtration</h2><p>When size of calibration dataset is greater then <em>max_frames_num</em> starts working<br>data filter. It tries to remove “bad” frames from dataset. Filter removes the frame<br> on which \f$loss_function\f$ takes maximum.</p>
<p>\f[loss_function(i)&#x3D;\alpha RMS(i)+(1-\alpha)reducedGridQuality(i)\f]</p>
<p><strong>RMS</strong> is an average re-projection error calculated for frame <em>i</em>, <strong>reducedGridQuality</strong><br> is scene coverage quality evaluation without frame <em>i</em>. \f$\alpha\f$ is equals to<br> <strong>frame_filter_conv_param</strong>.</p>
<h2 id="Calibration-process"><a href="#Calibration-process" class="headerlink" title="Calibration process"></a>Calibration process</h2><p>To start calibration just run application. Place pattern ahead the camera and fixate pattern in some pose.<br>After that wait for capturing (will be shown message like “Frame #i captured”).<br>Current focal distance and re-projection error will be shown at the main screen. Move pattern to the next position  and repeat procedure. Try to cover image plane<br>uniformly and don’t show pattern on sharp angles to the image plane.</p>
<p><img src="/images/screen_charuco.jpg"></p>
<p>If calibration seems to be successful (confidence intervals and average re-projection<br> error are small, frame coverage quality and number of pattern views are big enough)<br>  application will show a message like on screen below.</p>
<p><img src="/images/screen_finish.jpg"></p>
<p>Hot keys:</p>
<ul>
<li>Esc – exit application</li>
<li>s – save current data to XML file</li>
<li>r – delete last frame</li>
<li>d – delete all frames</li>
<li>u – enable&#x2F;disable applying of undistortion</li>
<li>v – switch visualization mode</li>
</ul>
<h2 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h2><p>As result you will get camera parameters and confidence intervals for them.</p>
<p>Example of output XML file:</p>
<p>@code{.xml}<br><?xml version="1.0"?><br><opencv_storage><br><calibrationDate>“Thu 07 Apr 2016 04:23:03 PM MSK”</calibrationDate><br><framesCount>21</framesCount><br><cameraResolution><br>  1280 720</cameraResolution><br><cameraMatrix type_id="opencv-matrix"><br>  <rows>3</rows><br>  <cols>3</cols><br>  <dt>d</dt><br>  <data><br>    1.2519588293098975e+03 0. 6.6684948780852471e+02 0.<br>    1.2519588293098975e+03 3.6298123112613683e+02 0. 0. 1.</data></cameraMatrix><br><cameraMatrix_std_dev type_id="opencv-matrix"><br>  <rows>4</rows><br>  <cols>1</cols><br>  <dt>d</dt><br>  <data><br>    0. 1.2887048808572649e+01 2.8536856683866230e+00<br>    2.8341737483430314e+00</data></cameraMatrix_std_dev><br><dist_coeffs type_id="opencv-matrix"><br>  <rows>1</rows><br>  <cols>5</cols><br>  <dt>d</dt><br>  <data><br>    1.3569117181595716e-01 -8.2513063822554633e-01 0. 0.<br>    1.6412101575010554e+00</data></dist_coeffs><br><dist_coeffs_std_dev type_id="opencv-matrix"><br>  <rows>5</rows><br>  <cols>1</cols><br>  <dt>d</dt><br>  <data><br>    1.5570675523402111e-02 8.7229075437543435e-02 0. 0.<br>    1.8382427901856876e-01</data></dist_coeffs_std_dev><br><avg_reprojection_error>4.2691743074130178e-01</avg_reprojection_error><br></opencv_storage><br>@endcode</p>
