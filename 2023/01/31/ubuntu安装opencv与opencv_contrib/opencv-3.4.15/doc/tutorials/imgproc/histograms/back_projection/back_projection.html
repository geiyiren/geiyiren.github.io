<h1 id="Back-Projection-tutorial-back-projection"><a href="#Back-Projection-tutorial-back-projection" class="headerlink" title="Back Projection {#tutorial_back_projection}"></a>Back Projection {#tutorial_back_projection}</h1><p>@prev_tutorial{tutorial_histogram_comparison}<br>@next_tutorial{tutorial_template_matching}</p>
<h2 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h2><p>In this tutorial you will learn:</p>
<ul>
<li>What is Back Projection and why it is useful</li>
<li>How to use the OpenCV function @ref cv::calcBackProject to calculate Back Projection</li>
<li>How to mix different channels of an image by using the OpenCV function @ref cv::mixChannels</li>
</ul>
<h2 id="Theory"><a href="#Theory" class="headerlink" title="Theory"></a>Theory</h2><h3 id="What-is-Back-Projection"><a href="#What-is-Back-Projection" class="headerlink" title="What is Back Projection?"></a>What is Back Projection?</h3><ul>
<li>Back Projection is a way of recording how well the pixels of a given image fit the distribution<br>of pixels in a histogram model.</li>
<li>To make it simpler: For Back Projection, you calculate the histogram model of a feature and then<br>use it to find this feature in an image.</li>
<li>Application example: If you have a histogram of flesh color (say, a Hue-Saturation histogram ),<br>then you can use it to find flesh color areas in an image:</li>
</ul>
<h3 id="How-does-it-work"><a href="#How-does-it-work" class="headerlink" title="How does it work?"></a>How does it work?</h3><ul>
<li><p>We explain this by using the skin example:</p>
</li>
<li><p>Let’s say you have gotten a skin histogram (Hue-Saturation) based on the image below. The<br>histogram besides is going to be our <em>model histogram</em> (which we know represents a sample of<br>skin tonality). You applied some mask to capture only the histogram of the skin area:<br><img src="/images/Back_Projection_Theory0.jpg" alt="T0"><br><img src="/images/Back_Projection_Theory1.jpg" alt="T1"></p>
</li>
<li><p>Now, let’s imagine that you get another hand image (Test Image) like the one below: (with its<br>respective histogram):<br><img src="/images/Back_Projection_Theory2.jpg" alt="T2"><br><img src="/images/Back_Projection_Theory3.jpg" alt="T3"></p>
</li>
<li><p>What we want to do is to use our <em>model histogram</em> (that we know represents a skin tonality) to<br>detect skin areas in our Test Image. Here are the steps<br>-#  In each pixel of our Test Image (i.e. \f$p(i,j)\f$ ), collect the data and find the<br>correspondent bin location for that pixel (i.e. \f$( h_{i,j}, s_{i,j} )\f$ ).<br>-#  Lookup the <em>model histogram</em> in the correspondent bin - \f$( h_{i,j}, s_{i,j} )\f$ - and read<br>the bin value.<br>-#  Store this bin value in a new image (<em>BackProjection</em>). Also, you may consider to normalize<br>the <em>model histogram</em> first, so the output for the Test Image can be visible for you.<br>-#  Applying the steps above, we get the following BackProjection image for our Test Image:</p>
<pre><code>![](images/Back_Projection_Theory4.jpg)
</code></pre>
<p>-#  In terms of statistics, the values stored in <em>BackProjection</em> represent the <em>probability</em><br>that a pixel in <em>Test Image</em> belongs to a skin area, based on the <em>model histogram</em> that we<br>use. For instance in our Test image, the brighter areas are more probable to be skin area<br>(as they actually are), whereas the darker areas have less probability (notice that these<br>“dark” areas belong to surfaces that have some shadow on it, which in turns affects the<br>detection).</p>
</li>
</ul>
<h2 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h2><ul>
<li><strong>What does this program do?</strong><ul>
<li>Loads an image</li>
<li>Convert the original to HSV format and separate only <em>Hue</em> channel to be used for the<br>Histogram (using the OpenCV function @ref cv::mixChannels )</li>
<li>Let the user to enter the number of bins to be used in the calculation of the histogram.</li>
<li>Calculate the histogram (and update it if the bins change) and the backprojection of the<br>same image.</li>
<li>Display the backprojection and the histogram in windows.</li>
</ul>
</li>
</ul>
<p>@add_toggle_cpp</p>
<ul>
<li><p><strong>Downloadable code</strong>:</p>
<ul>
<li>Click<br><a href="https://github.com/opencv/opencv/tree/3.4/samples/cpp/tutorial_code/Histograms_Matching/calcBackProject_Demo1.cpp">here</a><br>for the basic version (explained in this tutorial).</li>
<li>For stuff slightly fancier (using H-S histograms and floodFill to define a mask for the<br>skin area) you can check the <a href="https://github.com/opencv/opencv/tree/3.4/samples/cpp/tutorial_code/Histograms_Matching/calcBackProject_Demo2.cpp">improved<br>demo</a></li>
<li>…or you can always check out the classical<br><a href="https://github.com/opencv/opencv/tree/3.4/samples/cpp/camshiftdemo.cpp">camshiftdemo</a><br>in samples.</li>
</ul>
</li>
<li><p><strong>Code at glance:</strong><br>@include samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp<br>@end_toggle</p>
</li>
</ul>
<p>@add_toggle_java</p>
<ul>
<li><p><strong>Downloadable code</strong>:</p>
<ul>
<li>Click<br><a href="https://github.com/opencv/opencv/tree/3.4/samples/java/tutorial_code/Histograms_Matching/back_projection/CalcBackProjectDemo1.java">here</a><br>for the basic version (explained in this tutorial).</li>
<li>For stuff slightly fancier (using H-S histograms and floodFill to define a mask for the<br>skin area) you can check the <a href="https://github.com/opencv/opencv/tree/3.4/samples/java/tutorial_code/Histograms_Matching/back_projection/CalcBackProjectDemo2.java">improved<br>demo</a></li>
<li>…or you can always check out the classical<br><a href="https://github.com/opencv/opencv/tree/3.4/samples/cpp/camshiftdemo.cpp">camshiftdemo</a><br>in samples.</li>
</ul>
</li>
<li><p><strong>Code at glance:</strong><br>@include samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java<br>@end_toggle</p>
</li>
</ul>
<p>@add_toggle_python</p>
<ul>
<li><p><strong>Downloadable code</strong>:</p>
<ul>
<li>Click<br><a href="https://github.com/opencv/opencv/tree/3.4/samples/python/tutorial_code/Histograms_Matching/back_projection/calcBackProject_Demo1.py">here</a><br>for the basic version (explained in this tutorial).</li>
<li>For stuff slightly fancier (using H-S histograms and floodFill to define a mask for the<br>skin area) you can check the <a href="https://github.com/opencv/opencv/tree/3.4/samples/python/tutorial_code/Histograms_Matching/back_projection/calcBackProject_Demo2.py">improved<br>demo</a></li>
<li>…or you can always check out the classical<br><a href="https://github.com/opencv/opencv/tree/3.4/samples/cpp/camshiftdemo.cpp">camshiftdemo</a><br>in samples.</li>
</ul>
</li>
<li><p><strong>Code at glance:</strong><br>@include samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py<br>@end_toggle</p>
</li>
</ul>
<h2 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h2><ul>
<li><p>Read the input image:</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp Read the image<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java Read the image<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py Read the image<br>@end_toggle</p>
</li>
<li><p>Transform it to HSV format:</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp Transform it to HSV<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java Transform it to HSV<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py Transform it to HSV<br>@end_toggle</p>
</li>
<li><p>For this tutorial, we will use only the Hue value for our 1-D histogram (check out the fancier<br>code in the links above if you want to use the more standard H-S histogram, which yields better<br>results):</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp Use only the Hue value<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java Use only the Hue value<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py Use only the Hue value<br>@end_toggle</p>
</li>
<li><p>as you see, we use the function @ref cv::mixChannels to get only the channel 0 (Hue) from<br>the hsv image. It gets the following parameters:</p>
<ul>
<li><strong>&amp;hsv:</strong> The source array from which the channels will be copied</li>
<li><strong>1:</strong> The number of source arrays</li>
<li><strong>&amp;hue:</strong> The destination array of the copied channels</li>
<li><strong>1:</strong> The number of destination arrays</li>
<li><strong>ch[] &#x3D; {0,0}:</strong> The array of index pairs indicating how the channels are copied. In this<br>case, the Hue(0) channel of &amp;hsv is being copied to the 0 channel of &amp;hue (1-channel)</li>
<li><strong>1:</strong> Number of index pairs</li>
</ul>
</li>
<li><p>Create a Trackbar for the user to enter the bin values. Any change on the Trackbar means a call<br>to the <strong>Hist_and_Backproj</strong> callback function.</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp Create Trackbar to enter the number of bins<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java Create Trackbar to enter the number of bins<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py Create Trackbar to enter the number of bins<br>@end_toggle</p>
</li>
<li><p>Show the image and wait for the user to exit the program:</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp Show the image<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java Show the image<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py Show the image<br>@end_toggle</p>
</li>
<li><p><strong>Hist_and_Backproj function:</strong> Initialize the arguments needed for @ref cv::calcHist . The<br>number of bins comes from the Trackbar:</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp initialize<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java initialize<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py initialize<br>@end_toggle</p>
</li>
<li><p>Calculate the Histogram and normalize it to the range \f$[0,255]\f$</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp Get the Histogram and normalize it<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java Get the Histogram and normalize it<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py Get the Histogram and normalize it<br>@end_toggle</p>
</li>
<li><p>Get the Backprojection of the same image by calling the function @ref cv::calcBackProject</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp Get Backprojection<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java Get Backprojection<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py Get Backprojection<br>@end_toggle</p>
</li>
<li><p>all the arguments are known (the same as used to calculate the histogram), only we add the<br>backproj matrix, which will store the backprojection of the source image (&amp;hue)</p>
</li>
<li><p>Display backproj:</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp Draw the backproj<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java Draw the backproj<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py Draw the backproj<br>@end_toggle</p>
</li>
<li><p>Draw the 1-D Hue histogram of the image:</p>
<p>@add_toggle_cpp<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;calcBackProject_Demo1.cpp Draw the histogram<br>@end_toggle</p>
<p>@add_toggle_java<br>@snippet samples&#x2F;java&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;CalcBackProjectDemo1.java Draw the histogram<br>@end_toggle</p>
<p>@add_toggle_python<br>@snippet samples&#x2F;python&#x2F;tutorial_code&#x2F;Histograms_Matching&#x2F;back_projection&#x2F;calcBackProject_Demo1.py Draw the histogram<br>@end_toggle</p>
</li>
</ul>
<h2 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h2><p>Here are the output by using a sample image ( guess what? Another hand ). You can play with the<br>bin values and you will observe how it affects the results:<br><img src="/images/Back_Projection1_Source_Image.jpg" alt="R0"><br><img src="/images/Back_Projection1_Histogram.jpg" alt="R1"><br><img src="/images/Back_Projection1_BackProj.jpg" alt="R2"></p>
