<h1 id="Out-of-focus-Deblur-Filter-tutorial-out-of-focus-deblur-filter"><a href="#Out-of-focus-Deblur-Filter-tutorial-out-of-focus-deblur-filter" class="headerlink" title="Out-of-focus Deblur Filter {#tutorial_out_of_focus_deblur_filter}"></a>Out-of-focus Deblur Filter {#tutorial_out_of_focus_deblur_filter}</h1><p>@prev_tutorial{tutorial_distance_transform}<br>@next_tutorial{tutorial_motion_deblur_filter}</p>
<h2 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h2><p>In this tutorial you will learn:</p>
<ul>
<li>what a degradation image model is</li>
<li>what the PSF of an out-of-focus image is</li>
<li>how to restore a blurred image</li>
<li>what is a Wiener filter</li>
</ul>
<h2 id="Theory"><a href="#Theory" class="headerlink" title="Theory"></a>Theory</h2><p>@note The explanation is based on the books @cite gonzalez and @cite gruzman. Also, you can refer to Matlab’s tutorial <a href="https://www.mathworks.com/help/images/image-deblurring.html">Image Deblurring in Matlab</a> and the article <a href="http://yuzhikov.com/articles/BlurredImagesRestoration1.htm">SmartDeblur</a>.<br>@note The out-of-focus image on this page is a real world  image. The out-of-focus was achieved manually by camera optics.</p>
<h3 id="What-is-a-degradation-image-model"><a href="#What-is-a-degradation-image-model" class="headerlink" title="What is a degradation image model?"></a>What is a degradation image model?</h3><p>Here is a mathematical model of the image degradation in frequency domain representation:</p>
<p>\f[S &#x3D; H\cdot U + N\f]</p>
<p>where<br>\f$S\f$ is a spectrum of blurred (degraded) image,<br>\f$U\f$ is a spectrum of original true (undegraded) image,<br>\f$H\f$ is a frequency response of point spread function (PSF),<br>\f$N\f$ is a spectrum of additive noise.</p>
<p>The circular PSF is a good approximation of out-of-focus distortion. Such a PSF is specified by only one parameter - radius \f$R\f$. Circular PSF is used in this work.</p>
<p><img src="/psf.png" alt="Circular point spread function"></p>
<h3 id="How-to-restore-a-blurred-image"><a href="#How-to-restore-a-blurred-image" class="headerlink" title="How to restore a blurred image?"></a>How to restore a blurred image?</h3><p>The objective of restoration (deblurring) is to obtain an estimate of the original image. The restoration formula in frequency domain is:</p>
<p>\f[U’ &#x3D; H_w\cdot S\f]</p>
<p>where<br>\f$U’\f$ is the spectrum of estimation of original image \f$U\f$, and<br>\f$H_w\f$ is the restoration filter, for example, the Wiener filter.</p>
<h3 id="What-is-the-Wiener-filter"><a href="#What-is-the-Wiener-filter" class="headerlink" title="What is the Wiener filter?"></a>What is the Wiener filter?</h3><p>The Wiener filter is a way to restore a blurred image. Let’s suppose that the PSF is a real and symmetric signal, a power spectrum of the original true image and noise are not known,<br>then a simplified Wiener formula is:</p>
<p>\f[H_w &#x3D; \frac{H}{|H|^2+\frac{1}{SNR}} \f]</p>
<p>where<br>\f$SNR\f$ is signal-to-noise ratio.</p>
<p>So, in order to recover an out-of-focus image by Wiener filter, it needs to know the \f$SNR\f$ and \f$R\f$ of the circular PSF.</p>
<h2 id="Source-code"><a href="#Source-code" class="headerlink" title="Source code"></a>Source code</h2><p>You can find source code in the <code>samples/cpp/tutorial_code/ImgProc/out_of_focus_deblur_filter/out_of_focus_deblur_filter.cpp</code> of the OpenCV source code library.</p>
<p>@include cpp&#x2F;tutorial_code&#x2F;ImgProc&#x2F;out_of_focus_deblur_filter&#x2F;out_of_focus_deblur_filter.cpp</p>
<h2 id="Explanation"><a href="#Explanation" class="headerlink" title="Explanation"></a>Explanation</h2><p>An out-of-focus image recovering algorithm consists of PSF generation, Wiener filter generation and filtering a blurred image in frequency domain:<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;ImgProc&#x2F;out_of_focus_deblur_filter&#x2F;out_of_focus_deblur_filter.cpp main</p>
<p>A function calcPSF() forms a circular PSF according to input parameter radius \f$R\f$:<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;ImgProc&#x2F;out_of_focus_deblur_filter&#x2F;out_of_focus_deblur_filter.cpp calcPSF</p>
<p>A function calcWnrFilter() synthesizes the simplified Wiener filter \f$H_w\f$ according to the formula described above:<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;ImgProc&#x2F;out_of_focus_deblur_filter&#x2F;out_of_focus_deblur_filter.cpp calcWnrFilter</p>
<p>A function fftshift() rearranges the PSF. This code was just copied from the tutorial @ref tutorial_discrete_fourier_transform “Discrete Fourier Transform”:<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;ImgProc&#x2F;out_of_focus_deblur_filter&#x2F;out_of_focus_deblur_filter.cpp fftshift</p>
<p>A function filter2DFreq() filters the blurred image in the frequency domain:<br>@snippet samples&#x2F;cpp&#x2F;tutorial_code&#x2F;ImgProc&#x2F;out_of_focus_deblur_filter&#x2F;out_of_focus_deblur_filter.cpp filter2DFreq</p>
<h2 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h2><p>Below you can see the real out-of-focus image:<br><img src="/images/original.jpg" alt="Out-of-focus image"></p>
<p>And the following result has been computed with \f$R\f$ &#x3D; 53 and \f$SNR\f$ &#x3D; 5200 parameters:<br><img src="/images/recovered.jpg" alt="The restored (deblurred) image"></p>
<p>The Wiener filter was used, and values of \f$R\f$ and \f$SNR\f$ were selected manually to give the best possible visual result.<br>We can see that the result is not perfect, but it gives us a hint to the image’s content. With some difficulty, the text is readable.</p>
<p>@note The parameter \f$R\f$ is the most important. So you should adjust \f$R\f$ first, then \f$SNR\f$.<br>@note Sometimes you can observe the ringing effect in a restored image. This effect can be reduced with several methods. For example, you can taper input image edges.</p>
<p>You can also find a quick video demonstration of this on<br><a href="https://youtu.be/0bEcE4B0XP4">YouTube</a>.<br>@youtube{0bEcE4B0XP4}</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://www.mathworks.com/help/images/image-deblurring.html">Image Deblurring in Matlab</a> - Image Deblurring in Matlab</li>
<li><a href="http://yuzhikov.com/articles/BlurredImagesRestoration1.htm">SmartDeblur</a> - SmartDeblur site</li>
</ul>
<!-- invisible references list -->
