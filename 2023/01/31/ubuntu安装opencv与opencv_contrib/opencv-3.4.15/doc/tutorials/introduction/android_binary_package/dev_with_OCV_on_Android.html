<h1 id="Android-Development-with-OpenCV-tutorial-dev-with-OCV-on-Android"><a href="#Android-Development-with-OpenCV-tutorial-dev-with-OCV-on-Android" class="headerlink" title="Android Development with OpenCV {#tutorial_dev_with_OCV_on_Android}"></a>Android Development with OpenCV {#tutorial_dev_with_OCV_on_Android}</h1><p>@prev_tutorial{tutorial_O4A_SDK}<br>@next_tutorial{tutorial_android_ocl_intro}</p>
<p>This tutorial has been created to help you use OpenCV library within your Android project.</p>
<p>This guide was written with Windows 7 in mind, though it should work with any other OS supported by<br>OpenCV4Android SDK.</p>
<p>This tutorial assumes you have the following installed and configured:</p>
<ul>
<li>JDK</li>
<li>Android SDK and NDK</li>
<li>Eclipse IDE</li>
<li>ADT and CDT plugins for Eclipse</li>
</ul>
<p>If you need help with anything of the above, you may refer to our @ref tutorial_android_dev_intro guide.</p>
<p>This tutorial also assumes you have OpenCV4Android SDK already installed on your development machine<br>and OpenCV Manager on your testing device correspondingly. If you need help with any of these, you<br>may consult our @ref tutorial_O4A_SDK tutorial.</p>
<p>If you encounter any error after thoroughly following these steps, feel free to contact us via<br><a href="https://groups.google.com/group/android-opencv/">OpenCV4Android</a> discussion group or OpenCV <a href="https://forum.opencv.org/">Q&amp;A<br>forum</a> . We’ll do our best to help you out.</p>
<h2 id="Using-OpenCV-Library-Within-Your-Android-Project"><a href="#Using-OpenCV-Library-Within-Your-Android-Project" class="headerlink" title="Using OpenCV Library Within Your Android Project"></a>Using OpenCV Library Within Your Android Project</h2><p>In this section we will explain how to make some existing project to use OpenCV. Starting with 2.4.2<br>release for Android, <em>OpenCV Manager</em> is used to provide apps with the best available version of<br>OpenCV. You can get more information here: <code>Android OpenCV Manager</code> and in these<br><a href="https://docs.google.com/a/itseez.com/presentation/d/1EO_1kijgBg_BsjNp2ymk-aarg-0K279_1VZRcPplSuk/present#slide=id.p">slides</a>.</p>
<h3 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h3><h4 id="Application-Development-with-Async-Initialization"><a href="#Application-Development-with-Async-Initialization" class="headerlink" title="Application Development with Async Initialization"></a>Application Development with Async Initialization</h4><p>Using async initialization is a <strong>recommended</strong> way for application development. It uses the OpenCV<br>Manager to access OpenCV libraries externally installed in the target system.</p>
<p>-#  Add OpenCV library project to your workspace. Use menu<br>    File -&gt; Import -&gt; Existing project in your workspace.</p>
<pre><code>Press Browse button and locate OpenCV4Android SDK (`OpenCV-2.4.9-android-sdk/sdk`).

![](images/eclipse_opencv_dependency0.png)
</code></pre>
<p>-#  In application project add a reference to the OpenCV Java SDK in<br>    Project -&gt; Properties -&gt; Android -&gt; Library -&gt; Add select OpenCV Library - 2.4.9.</p>
<pre><code>![](images/eclipse_opencv_dependency1.png)
</code></pre>
<p>In most cases OpenCV Manager may be installed automatically from Google Play. For the case, when<br>Google Play is not available, i.e. emulator, developer board, etc, you can install it manually using<br>adb tool. See <code>Manager Selection</code> for details.</p>
<p>There is a very base code snippet implementing the async initialization. It shows basic principles.<br>See the “15-puzzle” OpenCV sample for details.<br>@code{.java}<br>public class Sample1Java extends Activity implements CvCameraViewListener {</p>
<pre><code>private BaseLoaderCallback mLoaderCallback = new BaseLoaderCallback(this) {
    @Override
    public void onManagerConnected(int status) {
        switch (status) {
            case LoaderCallbackInterface.SUCCESS:
            {
                Log.i(TAG, &quot;OpenCV loaded successfully&quot;);
                mOpenCvCameraView.enableView();
            } break;
            default:
            {
                super.onManagerConnected(status);
            } break;
        }
    }
};

@Override
public void onResume()
{
    super.onResume();
    OpenCVLoader.initAsync(OpenCVLoader.OPENCV_VERSION_2_4_6, this, mLoaderCallback);
}

...
</code></pre>
<p>}<br>@endcode<br>It this case application works with OpenCV Manager in asynchronous fashion. OnManagerConnected<br>callback will be called in UI thread, when initialization finishes. Please note, that it is not<br>allowed to use OpenCV calls or load OpenCV-dependent native libs before invoking this callback. Load<br>your own native libraries that depend on OpenCV after the successful OpenCV initialization. Default<br>BaseLoaderCallback implementation treat application context as Activity and calls Activity.finish()<br>method to exit in case of initialization failure. To override this behavior you need to override<br>finish() method of BaseLoaderCallback class and implement your own finalization method.</p>
<h4 id="Application-Development-with-Static-Initialization"><a href="#Application-Development-with-Static-Initialization" class="headerlink" title="Application Development with Static Initialization"></a>Application Development with Static Initialization</h4><p>According to this approach all OpenCV binaries are included into your application package. It is<br>designed mostly for development purposes. This approach is deprecated for the production code,<br>release package is recommended to communicate with OpenCV Manager via the async initialization<br>described above.</p>
<p>-#  Add the OpenCV library project to your workspace the same way as for the async initialization<br>    above. Use menu File -&gt; Import -&gt; Existing project in your workspace, press Browse button and<br>    select OpenCV SDK path (<code>OpenCV-2.4.9-android-sdk/sdk</code>).</p>
<pre><code>![](images/eclipse_opencv_dependency0.png)
</code></pre>
<p>-#  In the application project add a reference to the OpenCV4Android SDK in<br>    Project -&gt; Properties -&gt; Android -&gt; Library -&gt; Add select OpenCV Library - 2.4.9;</p>
<pre><code>![](images/eclipse_opencv_dependency1.png)
</code></pre>
<p>-#  If your application project <strong>doesn’t have a JNI part</strong>, just copy the corresponding OpenCV<br>    native libs from <code>&lt;OpenCV-2.4.9-android-sdk&gt;/sdk/native/libs/&lt;target_arch&gt;</code> to your project<br>    directory to folder <code>libs/&lt;target_arch&gt;</code>.</p>
<pre><code>In case of the application project **with a JNI part**, instead of manual libraries copying you
need to modify your Android.mk file: add the following two code lines after the
&quot;include $(CLEAR_VARS)&quot; and before
&quot;include path_to_OpenCV-2.4.9-android-sdk/sdk/native/jni/OpenCV.mk&quot;
@code{.make}
OPENCV_CAMERA_MODULES:=on
OPENCV_INSTALL_MODULES:=on
@endcode
The result should look like the following:
@code{.make}
include $(CLEAR_VARS)

# OpenCV
OPENCV_CAMERA_MODULES:=on
OPENCV_INSTALL_MODULES:=on
include ../../sdk/native/jni/OpenCV.mk
@endcode
After that the OpenCV libraries will be copied to your application `libs` folder during the JNI
build.v

Eclipse will automatically include all the libraries from the `libs` folder to the application
package (APK).
</code></pre>
<p>-#  The last step of enabling OpenCV in your application is Java initialization code before calling<br>    OpenCV API. It can be done, for example, in the static section of the Activity class:<br>    @code{.java}<br>    static {<br>        if (!OpenCVLoader.initDebug()) {<br>            &#x2F;&#x2F; Handle initialization error<br>        }<br>    }<br>    @endcode<br>    If you application includes other OpenCV-dependent native libraries you should load them<br>    <strong>after</strong> OpenCV initialization:<br>    @code{.java}<br>    static {<br>        if (!OpenCVLoader.initDebug()) {<br>            &#x2F;&#x2F; Handle initialization error<br>        } else {<br>            System.loadLibrary(“my_jni_lib1”);<br>            System.loadLibrary(“my_jni_lib2”);<br>        }<br>    }<br>    @endcode</p>
<h3 id="Native-x2F-C"><a href="#Native-x2F-C" class="headerlink" title="Native&#x2F;C++"></a>Native&#x2F;C++</h3><p>To build your own Android application, using OpenCV as native part, the following steps should be<br>taken:</p>
<p>-#  You can use an environment variable to specify the location of OpenCV package or just hardcode<br>    absolute or relative path in the <code>jni/Android.mk</code> of your projects.<br>-#  The file <code>jni/Android.mk</code> should be written for the current application using the common rules<br>    for this file.</p>
<pre><code>For detailed information see the Android NDK documentation from the Android NDK archive, in the
file `&lt;path_where_NDK_is_placed&gt;/docs/ANDROID-MK.html`.
</code></pre>
<p>-#  The following line:<br>    @code{.make}<br>    include C:\Work\OpenCV4Android\OpenCV-2.4.9-android-sdk\sdk\native\jni\OpenCV.mk<br>    @endcode<br>    Should be inserted into the <code>jni/Android.mk</code> file <strong>after</strong> this line:<br>    @code{.make}<br>    include $(CLEAR_VARS)<br>    @endcode<br>-#  Several variables can be used to customize OpenCV stuff, but you <strong>don’t need</strong> to use them when<br>    your application uses the async initialization via the OpenCV Manager API.</p>
<pre><code>@note These variables should be set **before** the &quot;include .../OpenCV.mk&quot; line:
@code{.make}
OPENCV_INSTALL_MODULES:=on
@endcode

Copies necessary OpenCV dynamic libs to the project libs folder in order to include them
into the APK.
@code{.make}
OPENCV_CAMERA_MODULES:=off
@endcode
Skip native OpenCV camera related libs copying to the project libs folder.
@code{.make}
OPENCV_LIB_TYPE:=STATIC
@endcode
Perform static linking with OpenCV. By default dynamic link is used and the project JNI lib
depends on libopencv_java.so.
</code></pre>
<p>-#  The file <code>Application.mk</code> should exist and should contain lines:<br>    @code{.make}<br>    APP_STL :&#x3D; gnustl_static<br>    APP_CPPFLAGS :&#x3D; -frtti -fexceptions<br>    @endcode<br>    Also, the line like this one:<br>    @code{.make}<br>    APP_ABI :&#x3D; armeabi-v7a<br>    @endcode<br>    Should specify the application target platforms.</p>
<pre><code>In some cases a linkage error (like
`&quot;In function &#39;cv::toUtf16(std::basic_string&lt;...&gt;... undefined reference to &#39;mbstowcs&#39;&quot;`)
happens when building an application JNI library, depending on OpenCV. The following line in the
`Application.mk` usually fixes it:
@code{.make}
APP_PLATFORM := android-9
@endcode
</code></pre>
<p>-#  Either use @ref tutorial_android_dev_intro_ndk “manual”  ndk-build invocation or<br>    @ref tutorial_android_dev_intro_eclipse “setup Eclipse CDT Builder” to build native JNI lib<br>    before (re)building the Java part and creating<br>    an APK.</p>
<h2 id="Hello-OpenCV-Sample"><a href="#Hello-OpenCV-Sample" class="headerlink" title="Hello OpenCV Sample"></a>Hello OpenCV Sample</h2><p>Here are basic steps to guide you trough the process of creating a simple OpenCV-centric<br>application. It will be capable of accessing camera output, processing it and displaying the result.</p>
<p>-#  Open Eclipse IDE, create a new clean workspace, create a new Android project<br>    File –&gt; New –&gt; Android Project<br>-#  Set name, target, package and minSDKVersion accordingly. The minimal SDK version for build with<br>    OpenCV4Android SDK is 11. Minimal device API Level (for application manifest) is 8.<br>-#  Allow Eclipse to create default activity. Lets name the activity HelloOpenCvActivity.<br>-#  Choose Blank Activity with full screen layout. Lets name the layout HelloOpenCvLayout.<br>-#  Import OpenCV library project to your workspace.<br>-#  Reference OpenCV library within your project properties.</p>
<pre><code>![](images/dev_OCV_reference.png)
</code></pre>
<p>-#  Edit your layout file as xml file and pass the following layout there:<br>    @code{.xml}<br>    <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:tools="http://schemas.android.com/tools"
        xmlns:opencv="http://schemas.android.com/apk/res-auto"
        android:layout_width="match_parent"
        android:layout_height="match_parent" ></p>
<pre><code>    &lt;org.opencv.android.JavaCameraView
        android:layout_width=&quot;fill_parent&quot;
        android:layout_height=&quot;fill_parent&quot;
        android:visibility=&quot;gone&quot;
        android:id=&quot;@+id/HelloOpenCvView&quot;
        opencv:show_fps=&quot;true&quot;
        opencv:camera_id=&quot;any&quot; /&gt;

&lt;/LinearLayout&gt;
@endcode
</code></pre>
<p>-#  Add the following permissions to the <code>AndroidManifest.xml</code> file:<br>    @code{.xml}<br>    </application></p>
<pre><code>&lt;uses-permission android:name=&quot;android.permission.CAMERA&quot;/&gt;

&lt;uses-feature android:name=&quot;android.hardware.camera&quot; android:required=&quot;false&quot;/&gt;
&lt;uses-feature android:name=&quot;android.hardware.camera.autofocus&quot; android:required=&quot;false&quot;/&gt;
&lt;uses-feature android:name=&quot;android.hardware.camera.front&quot; android:required=&quot;false&quot;/&gt;
&lt;uses-feature android:name=&quot;android.hardware.camera.front.autofocus&quot; android:required=&quot;false&quot;/&gt;
@endcode
</code></pre>
<p>-#  Set application theme in AndroidManifest.xml to hide title and system buttons.<br>    @code{.xml}<br>    <application
        android:icon="@drawable/icon"
        android:label="@string/app_name"
        android:theme="@android:style/Theme.NoTitleBar.Fullscreen" ><br>    @endcode<br>-#  Add OpenCV library initialization to your activity. Fix errors by adding required imports.<br>    @code{.java}<br>    private BaseLoaderCallback mLoaderCallback &#x3D; new BaseLoaderCallback(this) {<br>        @Override<br>        public void onManagerConnected(int status) {<br>            switch (status) {<br>                case LoaderCallbackInterface.SUCCESS:<br>                {<br>                    Log.i(TAG, “OpenCV loaded successfully”);<br>                    mOpenCvCameraView.enableView();<br>                } break;<br>                default:<br>                {<br>                    super.onManagerConnected(status);<br>                } break;<br>            }<br>        }<br>    };</p>
<pre><code>@Override
public void onResume()
{
    super.onResume();
    OpenCVLoader.initAsync(OpenCVLoader.OPENCV_VERSION_2_4_6, this, mLoaderCallback);
}
@endcode
</code></pre>
<p>-#  Defines that your activity implements CvCameraViewListener2 interface and fix activity related<br>    errors by defining missed methods. For this activity define onCreate, onDestroy and onPause and<br>    implement them according to the code snippet below. Fix errors by adding required imports.<br>    @code{.java}<br>    private CameraBridgeViewBase mOpenCvCameraView;</p>
<pre><code>@Override
public void onCreate(Bundle savedInstanceState) {
    Log.i(TAG, &quot;called onCreate&quot;);
    super.onCreate(savedInstanceState);
    getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);
    setContentView(R.layout.HelloOpenCvLayout);
    mOpenCvCameraView = (CameraBridgeViewBase) findViewById(R.id.HelloOpenCvView);
    mOpenCvCameraView.setVisibility(SurfaceView.VISIBLE);
    mOpenCvCameraView.setCvCameraViewListener(this);
}

@Override
public void onPause()
{
    super.onPause();
    if (mOpenCvCameraView != null)
        mOpenCvCameraView.disableView();
}

public void onDestroy() {
    super.onDestroy();
    if (mOpenCvCameraView != null)
        mOpenCvCameraView.disableView();
}

public void onCameraViewStarted(int width, int height) {
}

public void onCameraViewStopped() {
}

public Mat onCameraFrame(CvCameraViewFrame inputFrame) {
    return inputFrame.rgba();
}
@endcode
</code></pre>
<p>-#  Run your application on device or emulator.</p>
<p>Lets discuss some most important steps. Every Android application with UI must implement Activity<br>and View. By the first steps we create blank activity and default view layout. The simplest<br>OpenCV-centric application must implement OpenCV initialization, create its own view to show preview<br>from camera and implements CvCameraViewListener2 interface to get frames from camera and process it.</p>
<p>First of all we create our application view using xml layout. Our layout consists of the only one<br>full screen component of class org.opencv.android.JavaCameraView. This class is implemented inside<br>OpenCV library. It is inherited from CameraBridgeViewBase, that extends SurfaceView and uses<br>standard Android camera API.</p>
<p>After creating layout we need to implement Activity class. OpenCV initialization process has been<br>already discussed above. In this sample we use asynchronous initialization. Implementation of<br>CvCameraViewListener interface allows you to add processing steps after frame grabbing from camera<br>and before its rendering on screen. The most important function is onCameraFrame. It is callback<br>function and it is called on retrieving frame from camera. The callback input is object of<br>CvCameraViewFrame class that represents frame from camera.</p>
<p>@note Do not save or use CvCameraViewFrame object out of onCameraFrame callback. This object does<br>not have its own state and its behavior out of callback is unpredictable!</p>
<p>It has rgba() and gray()<br>methods that allows to get frame as RGBA and one channel gray scale Mat respectively. It expects<br>that onCameraFrame function returns RGBA frame that will be drawn on the screen.</p>
