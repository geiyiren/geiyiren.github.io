<h1 id="Face-landmark-detection-in-an-image-tutorial-face-landmark-detection-in-an-image"><a href="#Face-landmark-detection-in-an-image-tutorial-face-landmark-detection-in-an-image" class="headerlink" title="Face landmark detection in an image {#tutorial_face_landmark_detection_in_an_image}"></a>Face landmark detection in an image {#tutorial_face_landmark_detection_in_an_image}</h1><p><img src="/images/facereg.jpg"></p>
<p>This application lets you detect landmarks of detected faces in an image. You can detect landmarks of all the faces found in an image<br>and use them further in various applications like face swapping, face averaging etc.<br>This functionality is now available in OpenCV.</p>
<pre><code>// Command to be typed for running the sample
./sampleDetectLandmarks -file=trained_model.dat -face_cascade=lbpcascadefrontalface.xml -image=/path_to_image/image.jpg
</code></pre>
<h3 id="Description-of-command-parameters-tutorial-face-training-parameters"><a href="#Description-of-command-parameters-tutorial-face-training-parameters" class="headerlink" title="Description of command parameters {tutorial_face_training_parameters}"></a>Description of command parameters {tutorial_face_training_parameters}</h3><blockquote>
<ul>
<li><strong>model_filename</strong> f : (REQUIRED) A path to binary file storing the trained model which is to be loaded [example - &#x2F;data&#x2F;file.dat]</li>
<li><strong>image</strong> i : (REQUIRED) A path to image in which face landmarks have to be detected.[example - &#x2F;data&#x2F;image.jpg]</li>
<li><strong>face_cascade</strong> c : (REQUIRED) A path to the face cascade xml file which you want to use as a face detector.</li>
</ul>
</blockquote>
<h2 id="Understanding-code"><a href="#Understanding-code" class="headerlink" title="Understanding code"></a>Understanding code</h2><p><img src="/images/d.png"></p>
<p>This tutorial will explain the sample code for face landmark detection. Jumping directly to the code :</p>
<pre><code class="c++">CascadeClassifier face_cascade;
face_cascade.load(cascade_name);

Mat img = imread(image);
Ptr&lt;Facemark&gt; facemark = createFacemarkKazemi());
facemark-&gt;loadModel(filename);
cout&lt;&lt;&quot;Loaded model&quot;&lt;&lt;endl;
</code></pre>
<p>The above code creates a CascadeClassifier to detect face regions, and an instance of the face landmark detection class.<br>We need to load a pretrained model for face landmark detection, and a cascade file for the face detection.<br>It also loads the image in which landmarks have to be detected.</p>
<pre><code class="c++">vector&lt;Rect&gt; faces;
resize(img,img,Size(460,460),0,0,INTER_LINEAR_EXACT);

Mat gray;
std::vector&lt;Rect&gt; faces;
if(img.channels()&gt;1){
    cvtColor(img.getMat(),gray,COLOR_BGR2GRAY);
}
else{
    gray = img.getMat().clone();
}
equalizeHist( gray, gray );

face_cascade.detectMultiScale( gray, faces, 1.1, 3,0, Size(30, 30) );
</code></pre>
<p>After doing some preprocessing, we first have to detect possible face regions (which will be stored in a <code>vector&lt;Rect&gt;</code>.<br>Also, the image is resized to a smaller size as processing speed is faster with small images.</p>
<pre><code class="c++">vector&lt; vector&lt;Point2f&gt; &gt; shapes;

if (facemark-&gt;fit(img,faces,shapes))
{
    for ( size_t i = 0; i &lt; faces.size(); i++ )
    {
        cv::rectangle(img,faces[i],Scalar( 255, 0, 0 ));
    }
    for (unsigned long i=0;i&lt;faces.size();i++){
        for(unsigned long k=0;k&lt;shapes[i].size();k++)
            cv::circle(img,shapes[i][k],5,cv::Scalar(0,0,255),FILLED);
    }
    namedWindow(&quot;Detected_shape&quot;);
    imshow(&quot;Detected_shape&quot;,img);
    waitKey(0);
}
</code></pre>
<p>It then creates a vector of vector to store shapes for each face detected.<br>The above code calls the function fit to get shapes of all detected faces in the image<br>and then draws the rectangles bounding the faces and marks the desired landmarks.</p>
<h3 id="Detection-Results"><a href="#Detection-Results" class="headerlink" title="Detection Results"></a>Detection Results</h3><p><img src="/ab.jpg"></p>
<p><img src="/ab-1.jpg"></p>
