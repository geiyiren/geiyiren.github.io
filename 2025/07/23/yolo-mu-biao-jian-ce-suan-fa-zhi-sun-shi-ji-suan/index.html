<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="yolo目标检测算法之损失计算, geiyiren">
    <meta name="description" content="分析ultralytics代码中目标检测算法中损失计算方法">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>yolo目标检测算法之损失计算 | geiyiren</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/css/matery.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/css/my.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/css/reward.css">
    



    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">geiyiren</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a target="_blank" rel="noopener" href="https://github.dev/geiyiren/MyBlog" class="waves-effect waves-light">
      
      <i class="fas fa-edit" style="zoom: 0.6;"></i>
      
      <span>编辑</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">geiyiren</div>
        <div class="logo-desc">
            
            geiyiren的博客
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a target="_blank" rel="noopener" href="https://github.dev/geiyiren/MyBlog" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-edit"></i>
			
			编辑
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/geiyiren" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/geiyiren" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '31faa2bf193e0267926799e680a8c29ce462ce35739844b4533598fbee437ea5';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">yolo目标检测算法之损失计算</h1>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">
    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/yolo/">
                                <span class="chip bg-color">yolo</span>
                            </a>
                        
                            <a href="/tags/loss/">
                                <span class="chip bg-color">loss</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/ultralytics/" class="post-category">
                                ultralytics
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-07-23
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-09-22
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    15.5k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Ultralytics系列"><a href="#Ultralytics系列" class="headerlink" title="Ultralytics系列"></a>Ultralytics系列</h1><h2 id="损失函数的调用关系"><a href="#损失函数的调用关系" class="headerlink" title="损失函数的调用关系"></a>损失函数的调用关系</h2><p>ultralytics代码中创建模型后顺手做了对应模型架构的加载，根据输入的 yaml文件将对应的模型加载为torch.nn.Module,同时也根据模型的类型对损失函数进行了选择。因此要想知道模型实际计算损失时使用了哪些损失计算方法就要从<code>model = YOLO(&quot;yolo12n.yaml&quot;)</code>开始入手，因此这一行代码过后模型的损失计算方法就已经设定好了，下面看下具体的流程：</p>
<ul>
<li><p>1.创建模型</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span><span class="token string">"yolo12n.yaml"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>2.生成模型任务类型和调用方法的对应关系</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">ultralytics<span class="token operator">/</span>models<span class="token operator">/</span>yolo<span class="token operator">/</span>model<span class="token punctuation">.</span>py
└── <span class="token keyword">class</span> <span class="token class-name">YOLO</span>
    └── <span class="token keyword">def</span> <span class="token function">task_map</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token triple-quoted-string string">"""Map head to model, trainer, validator, and predictor classes."""</span>
            <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
                <span class="token string">"classify"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"model"</span><span class="token punctuation">:</span> ClassificationModel<span class="token punctuation">,</span>
                    <span class="token string">"trainer"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>classify<span class="token punctuation">.</span>ClassificationTrainer<span class="token punctuation">,</span>
                    <span class="token string">"validator"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>classify<span class="token punctuation">.</span>ClassificationValidator<span class="token punctuation">,</span>
                    <span class="token string">"predictor"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>classify<span class="token punctuation">.</span>ClassificationPredictor<span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token string">"detect"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"model"</span><span class="token punctuation">:</span> DetectionModel<span class="token punctuation">,</span>
                    <span class="token string">"trainer"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>detect<span class="token punctuation">.</span>DetectionTrainer<span class="token punctuation">,</span>
                    <span class="token string">"validator"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>detect<span class="token punctuation">.</span>DetectionValidator<span class="token punctuation">,</span>
                    <span class="token string">"predictor"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>detect<span class="token punctuation">.</span>DetectionPredictor<span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token string">"segment"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"model"</span><span class="token punctuation">:</span> SegmentationModel<span class="token punctuation">,</span>
                    <span class="token string">"trainer"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>segment<span class="token punctuation">.</span>SegmentationTrainer<span class="token punctuation">,</span>
                    <span class="token string">"validator"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>segment<span class="token punctuation">.</span>SegmentationValidator<span class="token punctuation">,</span>
                    <span class="token string">"predictor"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>segment<span class="token punctuation">.</span>SegmentationPredictor<span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token string">"pose"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"model"</span><span class="token punctuation">:</span> PoseModel<span class="token punctuation">,</span>
                    <span class="token string">"trainer"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>PoseTrainer<span class="token punctuation">,</span>
                    <span class="token string">"validator"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>PoseValidator<span class="token punctuation">,</span>
                    <span class="token string">"predictor"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>pose<span class="token punctuation">.</span>PosePredictor<span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                <span class="token string">"obb"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
                    <span class="token string">"model"</span><span class="token punctuation">:</span> OBBModel<span class="token punctuation">,</span>
                    <span class="token string">"trainer"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>obb<span class="token punctuation">.</span>OBBTrainer<span class="token punctuation">,</span>
                    <span class="token string">"validator"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>obb<span class="token punctuation">.</span>OBBValidator<span class="token punctuation">,</span>
                    <span class="token string">"predictor"</span><span class="token punctuation">:</span> yolo<span class="token punctuation">.</span>obb<span class="token punctuation">.</span>OBBPredictor<span class="token punctuation">,</span>
                <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里返回了不同任务类型的<strong>模型加载器，训练器，评估器和预测器</strong>。可见对于目标检测任务：</p>
<ul>
<li>“model”: DetectionModel,</li>
<li>“trainer”: yolo.detect.DetectionTrainer,</li>
<li>“validator”: yolo.detect.DetectionValidator,</li>
<li>“predictor”: yolo.detect.DetectionPredictor,</li>
</ul>
</li>
</ul>
<p>对于目标检测模型而言，<code>class DetectionModel</code>继承了<code>class BaseModel</code>,而在<code>class BaseModel</code>中定义了<code>loss()</code>函数，该函数的定义如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">BaseModel</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">loss</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch<span class="token punctuation">,</span> preds<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Compute loss.

        Args:
            batch (dict): Batch to compute loss on.
            preds (torch.Tensor | List[torch.Tensor], optional): Predictions.
        """</span>
        <span class="token keyword">if</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"criterion"</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>criterion <span class="token operator">=</span> self<span class="token punctuation">.</span>init_criterion<span class="token punctuation">(</span><span class="token punctuation">)</span>

        preds <span class="token operator">=</span> self<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">"img"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> preds <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">else</span> preds
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>criterion<span class="token punctuation">(</span>preds<span class="token punctuation">,</span> batch<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看出在调用loss函数是，首先获得损失计算方法，然后进行模型推理并获得推理结果，最后调用了<code>init_criterion()</code>函数返回的损失计算方法计算损失并返回。但在<code>class BaseModel</code>中定义的<code>init_criterion()</code>函数并未实际实现，当子类<code>DetectionModel</code>继承父类<code>BaseModel</code>的时候对该方法进行了实现:</p>
<p>父类中定义虚函数:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">BaseModel</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">init_criterion</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize the loss criterion for the BaseModel."""</span>
        <span class="token keyword">raise</span> NotImplementedError<span class="token punctuation">(</span><span class="token string">"compute_loss() needs to be implemented by task heads"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>子类中实现该函数:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">DetectionModel</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>   
   <span class="token keyword">def</span> <span class="token function">init_criterion</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize the loss criterion for the DetectionModel."""</span>
        <span class="token keyword">return</span> E2EDetectLoss<span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token builtin">getattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">"end2end"</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token keyword">else</span> v8DetectionLoss<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里可以看出如果使用端到端检测模型则使用<code>E2EDetectLoss</code>计算损失，否则使用<code>v8DetectionLoss</code>计算损失，那么<code>end2end</code>又是在哪里配置的:</p>
<p><code>end2end</code>配置在<code>ultralytics/nn/modules/head.py</code>文件中根据模型使用不同的<code>检测头</code>进行默认的配置，具体情况如下:</p>
<ul>
<li>v10Detect<code>检测头</code>配置为True</li>
<li>Detect<code>检测头</code>配置为False</li>
</ul>
<p>因此，除yoloV10外，均使用<code>v8DetectionLoss</code>作为目标检测的损失计算方法</p>
<h2 id="v8DetectionLoss"><a href="#v8DetectionLoss" class="headerlink" title="v8DetectionLoss"></a>v8DetectionLoss</h2><h3 id="box解析"><a href="#box解析" class="headerlink" title="box解析"></a>box解析</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> batch<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Calculate the sum of the loss for box, cls and dfl multiplied by batch size."""</span>
        loss <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># box, cls, dfl</span>
        feats <span class="token operator">=</span> preds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>preds<span class="token punctuation">,</span> <span class="token builtin">tuple</span><span class="token punctuation">)</span> <span class="token keyword">else</span> preds
        pred_distri<span class="token punctuation">,</span> pred_scores <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>xi<span class="token punctuation">.</span>view<span class="token punctuation">(</span>feats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>no<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> xi <span class="token keyword">in</span> feats<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>
            <span class="token punctuation">(</span>self<span class="token punctuation">.</span>reg_max <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span>
        <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先解释一下<code>anchor free</code>，yolov8开始基于<code>anchor free</code>的思想进行标签框预测，原来是为每个<code>gride</code>预测三个不同比例的标签框，然后进行标签框的损失计算与筛选，<code>anchor free</code>可以认为为每个<code>gride</code>预测<code>reg_max</code>个标签框，然后进行标签框的损失计算与筛选。这里以<code>batch size</code>为16，输入图像为<code>480x480</code>为例，看下得到的张量的尺寸:</p>
<table>
<thead>
<tr>
<th>张量</th>
<th>shape</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>preds[0]</code></td>
<td><code>[16, 65, 60, 60]</code></td>
<td>特征层 1 输出，<code>16</code> batch，<code>65</code> channel（4*reg_max + 1 分类），<code>60x60</code> 特征图</td>
</tr>
<tr>
<td><code>preds[1]</code></td>
<td><code>[16, 65, 30, 30]</code></td>
<td>特征层 2 输出，<code>30x30</code> 特征图</td>
</tr>
<tr>
<td><code>preds[2]</code></td>
<td><code>[16, 65, 15, 15]</code></td>
<td>特征层 3 输出，<code>15x15</code> 特征图</td>
</tr>
<tr>
<td><code>pred_distri</code></td>
<td><code>[16, 4725, 64]</code></td>
<td>边框分布预测，<code>4725</code> &#x3D; 60x60+30x30+15x15，<code>64</code> &#x3D; 4*reg_max</td>
</tr>
<tr>
<td><code>pred_scores</code></td>
<td><code>[16, 4725, 1]</code></td>
<td>分类预测分数，每个 gride 对应一个类别得分（这里假设单类）</td>
</tr>
</tbody></table>
<p>也就是说网络预测了<code>4725</code>个目标框用于后期的损失计算和筛选。</p>
<p>然后计算所有<code>gride</code>的中心点坐标，代码如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> batch<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">:</span>
	<span class="token comment"># 省略无关代码...</span>
    anchor_points<span class="token punctuation">,</span> stride_tensor <span class="token operator">=</span> make_anchors<span class="token punctuation">(</span>feats<span class="token punctuation">,</span> self<span class="token punctuation">.</span>stride<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">make_anchors</span><span class="token punctuation">(</span>feats<span class="token punctuation">,</span> strides<span class="token punctuation">,</span> grid_cell_offset<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Generate anchors from features."""</span>
    anchor_points<span class="token punctuation">,</span> stride_tensor <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">assert</span> feats <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span>
    dtype<span class="token punctuation">,</span> device <span class="token operator">=</span> feats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> feats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>device
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> stride <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>strides<span class="token punctuation">)</span><span class="token punctuation">:</span>
        h<span class="token punctuation">,</span> w <span class="token operator">=</span> feats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>feats<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>feats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>feats<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        sx <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>end<span class="token operator">=</span>w<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">)</span> <span class="token operator">+</span> grid_cell_offset  <span class="token comment"># shift x</span>
        sy <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>end<span class="token operator">=</span>h<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">)</span> <span class="token operator">+</span> grid_cell_offset  <span class="token comment"># shift y</span>
        sy<span class="token punctuation">,</span> sx <span class="token operator">=</span> torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>sy<span class="token punctuation">,</span> sx<span class="token punctuation">,</span> indexing<span class="token operator">=</span><span class="token string">"ij"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> TORCH_1_10 <span class="token keyword">else</span> torch<span class="token punctuation">.</span>meshgrid<span class="token punctuation">(</span>sy<span class="token punctuation">,</span> sx<span class="token punctuation">)</span>
        anchor_points<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>sx<span class="token punctuation">,</span> sy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        stride_tensor<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">*</span> w<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stride<span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>anchor_points<span class="token punctuation">)</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>stride_tensor<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>torch.arange为生成均匀数列，范围为$[0,end-1]$,然后加上<code>grid_cell_offset</code>就得到了所有<code>gride</code>的中心点坐标<code>anchor_points</code></p>
<p>然后获得标签框的信息：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> batch<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token comment"># 省略无关代码... </span>
    <span class="token comment"># Targets</span>
    targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">"batch_idx"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch<span class="token punctuation">[</span><span class="token string">"cls"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> batch<span class="token punctuation">[</span><span class="token string">"bboxes"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    targets <span class="token operator">=</span> self<span class="token punctuation">.</span>preprocess<span class="token punctuation">(</span>targets<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> scale_tensor<span class="token operator">=</span>imgsz<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    gt_labels<span class="token punctuation">,</span> gt_bboxes <span class="token operator">=</span> targets<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># cls, xyxy</span>
    mask_gt <span class="token operator">=</span> gt_bboxes<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>gt_<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先看这里得到的数据的维度信息：</p>
<table>
<thead>
<tr>
<th>Tensor</th>
<th>Shape</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>targets</code></td>
<td><code>[16, 3, 5]</code></td>
<td>batch 16 张图，每张图最多 3 个标签，每个标签 5 个元素 <code>[cls, x1, y1, x2, y2]</code></td>
</tr>
<tr>
<td><code>gt_labels</code></td>
<td><code>[16, 3, 1]</code></td>
<td>batch 16 张图，每张图最多 3 个标签，每个标签类别</td>
</tr>
<tr>
<td><code>gt_bboxes</code></td>
<td><code>[16, 3, 4]</code></td>
<td>batch 16 张图，每张图最多 3 个标签，每个标签 bbox <code>[x1,y1,x2,y2]</code></td>
</tr>
<tr>
<td><code>batch[&quot;bboxes&quot;]</code></td>
<td><code>[10, 4]</code></td>
<td>当前 batch 总共有 10 个标签框</td>
</tr>
<tr>
<td><code>batch[&quot;cls&quot;]</code></td>
<td><code>[10, 1]</code></td>
<td>当前 batch 总共 10 个标签类别</td>
</tr>
<tr>
<td><code>batch[&quot;batch_idx&quot;]</code></td>
<td><code>[10]</code></td>
<td>每个标签框对应图像索引（0~15）</td>
</tr>
<tr>
<td><code>mask_gt</code></td>
<td><code>[16, 3, 1]</code></td>
<td>gt_bboxes 是否有效（非零 bbox）</td>
</tr>
</tbody></table>
<blockquote>
<p><code>targets</code>的第二维不是固定为 3，而是 <code>batch</code> 中 某张图的最大标签数</p>
</blockquote>
<p>这里得到了所有标签框的信息，随后将构建预测框的信息：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> batch<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token comment"># 省略无关代码... </span>
    <span class="token comment"># Pboxes</span>
    pred_bboxes <span class="token operator">=</span> self<span class="token punctuation">.</span>bbox_decode<span class="token punctuation">(</span>anchor_points<span class="token punctuation">,</span> pred_distri<span class="token punctuation">)</span>  <span class="token comment"># xyxy, (b, h*w, 4)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-python" data-language="python"><code class="language-python">
<span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> tal_topk<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># model must be de-paralleled</span>
	<span class="token comment">#省略无关代码...</span>
    self<span class="token punctuation">.</span>proj <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>m<span class="token punctuation">.</span>reg_max<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">bbox_decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> anchor_points<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> pred_dist<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Decode predicted object bounding box coordinates from anchor points and distribution."""</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_dfl<span class="token punctuation">:</span>
        b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> c <span class="token operator">=</span> pred_dist<span class="token punctuation">.</span>shape  <span class="token comment"># batch, anchors, channels</span>
        pred_dist <span class="token operator">=</span> pred_dist<span class="token punctuation">.</span>view<span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> c <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>softmax<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>self<span class="token punctuation">.</span>proj<span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>pred_dist<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># pred_dist = pred_dist.view(b, a, c // 4, 4).transpose(2,3).softmax(3).matmul(self.proj.type(pred_dist.dtype))</span>
        <span class="token comment"># pred_dist = (pred_dist.view(b, a, c // 4, 4).softmax(2) * self.proj.type(pred_dist.dtype).view(1, 1, -1, 1)).sum(2)</span>
    <span class="token keyword">return</span> dist2bbox<span class="token punctuation">(</span>pred_dist<span class="token punctuation">,</span> anchor_points<span class="token punctuation">,</span> xywh<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>都行大概看一下这里在干什么，<code>pred_dist</code>为网络直接的预测结果，首先进行维度变换<code>view</code>,然后对第3个维度的数据进行了归一化<code>softmax</code>:</p>
<p><img src="https://cdn.jsdelivr.net/gh/geiyiren/MyBlogImage1/yolo%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%AE%97%E6%B3%95%E4%B9%8B%E6%8D%9F%E5%A4%B1%E8%AE%A1%E7%AE%97/Softmax.png" alt="Softmax"></p>
<p>最后又和某个矩阵进行了矩阵乘法运算<code>matmul</code>，最终得到了<code>pred_dist</code>。看起来这里是有一个数学公式在支持，那我们就看下这个数学运算在干什么：</p>
<ul>
<li><h3 id="1️⃣-定义"><a href="#1️⃣-定义" class="headerlink" title="1️⃣ 定义"></a>1️⃣ 定义</h3></li>
<li><p><code>reg_max = N</code></p>
</li>
<li><p>偏移量离散化为 bin：<code>0, 1, 2, ..., N</code></p>
</li>
<li><p>对应的概率：<code>p_0, p_1, ..., p_N</code>，满足 <strong>概率和为 1</strong>：</p>
</li>
</ul>
<p>$$<br>\sum_{i&#x3D;0}^{N} p_i &#x3D; 1<br>$$</p>
<ul>
<li>连续偏移量计算公式：</li>
</ul>
<p>$$<br>\text{offset} &#x3D; \sum_{i&#x3D;0}^{N} p_i \cdot i<br>$$</p>
<ul>
<li><h3 id="2️⃣-求最大值"><a href="#2️⃣-求最大值" class="headerlink" title="2️⃣ 求最大值"></a>2️⃣ 求最大值</h3></li>
</ul>
<p>这是一个 <strong>线性函数在简单约束条件下的极值问题</strong>：</p>
<ul>
<li>函数：</li>
</ul>
<p>$$<br>f(p_0, …, p_N) &#x3D; \sum_{i&#x3D;0}^{N} i , p_i<br>$$</p>
<ul>
<li>约束条件：</li>
</ul>
<p>$$<br>p_i \ge 0, \quad \sum_{i&#x3D;0}^{N} p_i &#x3D; 1<br>$$</p>
<p>根据 <strong>线性规划原理</strong>，线性函数在概率单纯形上的最大值出现在一个顶点，也就是 <strong>概率全部集中在最大 bin 上</strong>：<br>$$<br>p_N &#x3D; 1, \quad p_{0..N-1} &#x3D; 0<br>$$</p>
<ul>
<li><h3 id="3️⃣-最大-offset"><a href="#3️⃣-最大-offset" class="headerlink" title="3️⃣ 最大 offset"></a>3️⃣ 最大 offset</h3></li>
</ul>
<p>$$<br>\text{offset}<em>{\max} &#x3D; \sum</em>{i&#x3D;0}^{N} i , p_i &#x3D; N \cdot 1 + 0 &#x3D; N<br>$$</p>
<p>这样我们就理解这里是在计算什么东西了，其实就是对于每个<code>gride</code>预测了<code>reg_&#123;max&#125;*4</code>个概率值，分别和向量$[0,1,2,…,reg_{max}-1]$相乘后得到相对对于<code>gride</code>中心的四个方向的偏移值$(l,t.r,b)$,后面就可以根据<code>gride</code>中心坐标得到真实的预测框坐标，注意这里最终每个gride只会得到❓个预测框，至此我们还不知道每个<code>gride</code>预测几个框，后面会做补充说明。不过这里有几点思考：</p>
<ul>
<li><p>理论上预测的是相对于<code>gride</code>的偏移，<code>reg_max=1</code>似乎就够用了，怎么默认设置为16？</p>
<p>如果<code>reg_max=10</code>，则最大的<code>offset</code>为10，完全可以有一个gride偏移到另一个偏移量，实现整个特张图的预测框覆盖。</p>
<p>(1) <strong>离散表示精度</strong></p>
<ul>
<li>reg_max&#x3D;1 → 只有两个 bin → softmax 分布非常尖锐<ul>
<li>例如 p_1&#x3D;0.3 → 偏移量 &#x3D; 0.3</li>
<li>只能通过 p_1 来表示，梯度对 p_1 非常敏感</li>
</ul>
</li>
<li>reg_max&#x3D;16 → 16 个 bin → softmax 分布更平滑<ul>
<li>偏移量 &#x3D; 加权平均多达 16 个 bin</li>
<li>预测更平滑，梯度传播更稳定</li>
</ul>
</li>
</ul>
<p>(2) <strong>梯度传递稳定性</strong></p>
<ul>
<li>bin 太少 → softmax 输出只有 2 个概率 → 梯度大幅波动 → 训练不稳定</li>
<li>bin 多 → softmax 输出 16 个概率 → 梯度可以分散 → 更容易收敛</li>
</ul>
<p>(3) <strong>预测自由度与噪声抑制</strong></p>
<ul>
<li>多 bin → 可以表示更复杂的概率分布</li>
<li>可以让模型在预测偏移时“分散风险”，抑制噪声</li>
<li>少 bin → 模型预测更二值化，容易出现不稳定或震荡</li>
</ul>
<p>(4) <strong>最大预测框的尺寸</strong></p>
<ul>
<li>如果reg_max&#x3D;N，也就是最大的<code>offset</code>为N，即：预测框左侧最多可以偏移N个<code>gride</code>,右&#x2F;上&#x2F;下方向也是，那么预测框的最大尺寸为2N个<code>gride</code>,那么在实际图像上的尺寸应该是第三个分支或<code>stride</code>最大，降采样倍率最高的那个分支预测的框，也就是说reg_max和预测最大目标的尺寸紧密相关，如下所示：<br>$$<br>obj_{max} &#x3D; reg_{max}<em>2</em>stride<br>$$</li>
</ul>
</li>
</ul>
<p>然后我们看下解析出来的四个方向的偏移量是如何得到每个<code>gride</code>的预测框的：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">dist2bbox</span><span class="token punctuation">(</span>distance<span class="token punctuation">,</span> anchor_points<span class="token punctuation">,</span> xywh<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Transform distance(ltrb) to box(xywh or xyxy)."""</span>
    lt<span class="token punctuation">,</span> rb <span class="token operator">=</span> distance<span class="token punctuation">.</span>chunk<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> dim<span class="token punctuation">)</span>
    x1y1 <span class="token operator">=</span> anchor_points <span class="token operator">-</span> lt
    x2y2 <span class="token operator">=</span> anchor_points <span class="token operator">+</span> rb
    <span class="token keyword">if</span> xywh<span class="token punctuation">:</span>
        c_xy <span class="token operator">=</span> <span class="token punctuation">(</span>x1y1 <span class="token operator">+</span> x2y2<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
        wh <span class="token operator">=</span> x2y2 <span class="token operator">-</span> x1y1
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>c_xy<span class="token punctuation">,</span> wh<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token punctuation">)</span>  <span class="token comment"># xywh bbox</span>
    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x1y1<span class="token punctuation">,</span> x2y2<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token punctuation">)</span>  <span class="token comment"># xyxy bbox</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里根据<code>gride</code>的中心点和四个方向的偏移量就可以得到框的左上角坐标和右下角坐标，奥…原来网络预测的结果是框相对于gride的中心偏移量。这里就得到了特张图尺度下的预测框的位置。</p>
<h3 id="标签分配"><a href="#标签分配" class="headerlink" title="标签分配"></a>标签分配</h3><p>该方法的实现在<code>TaskAlignedAssigner</code>类中，首先大概看下这个方法的输入是什么，输出是什么：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> batch<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">:</span> 
    <span class="token comment"># 省略无关代码...</span>
    _<span class="token punctuation">,</span> target_bboxes<span class="token punctuation">,</span> target_scores<span class="token punctuation">,</span> fg_mask<span class="token punctuation">,</span> _ <span class="token operator">=</span> self<span class="token punctuation">.</span>assigner<span class="token punctuation">(</span>
            <span class="token comment"># pred_scores.detach().sigmoid() * 0.8 + dfl_conf.unsqueeze(-1) * 0.2,</span>
            pred_scores<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>pred_bboxes<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> stride_tensor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>gt_bboxes<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span>
            anchor_points <span class="token operator">*</span> stride_tensor<span class="token punctuation">,</span>
            gt_labels<span class="token punctuation">,</span>
            gt_bboxes<span class="token punctuation">,</span>
            mask_gt<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>输入<ul>
<li><code>pred_scores</code>：这个是预测框的置信度，同时进行了归一化，使得每个<code>batch</code>内所有预测框的概率之和为1。</li>
<li><code>pred_bboxes</code>：这个是预测框的<code>xyxy</code>，同时进行了缩放，将其缩放到输入图像尺度。</li>
<li><code>anchor_points</code>：这个是每个特征图上对应<code>gride</code>的中心点，同时进行了缩放，将其缩放到输入图像尺度。</li>
<li><code>gt_labels</code>：这个是标签id</li>
<li><code>gt_bboxes</code>：这个是标签的位置<code>xyxy</code>，且在输入图像尺度下。</li>
<li><code>mask_gt</code>：这个是哪些标签框是有效的，因为这里得到的每个图像的标签框个数被强制设置为整个<code>batch</code>中各个图像中标签框个数的最大值，不够的被填充0，这里是得到非0的标签框的索引</li>
</ul>
</li>
<li>输出<ul>
<li><code>target_bboxes</code></li>
<li><code>target_scores</code></li>
<li><code>fg_mask</code></li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>张量名称</th>
<th>Shape</th>
</tr>
</thead>
<tbody><tr>
<td><code>pred_scores</code></td>
<td><code>[16, 4725, 1]</code></td>
</tr>
<tr>
<td><code>pred_bboxes</code></td>
<td><code>[16, 4725, 4]</code></td>
</tr>
<tr>
<td><code>anchor_points</code></td>
<td><code>[4725, 2]</code></td>
</tr>
<tr>
<td><code>gt_labels</code></td>
<td><code>[16, 7, 1]</code></td>
</tr>
<tr>
<td><code>gt_bboxes</code></td>
<td><code>[16, 7, 4]</code></td>
</tr>
<tr>
<td><code>mask_gt</code></td>
<td><code>[16, 7, 1]</code></td>
</tr>
<tr>
<td><code>target_bboxes</code></td>
<td><code>[16, 4725, 4]</code></td>
</tr>
<tr>
<td><code>target_scores</code></td>
<td><code>[16, 4725, 1]</code></td>
</tr>
<tr>
<td><code>fg_mask</code></td>
<td><code>[16, 4725]</code></td>
</tr>
</tbody></table>
<p>然后看一下具体是如何实现的，整体过程如下所示：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">TaskAlignedAssigner</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pd_scores<span class="token punctuation">,</span> pd_bboxes<span class="token punctuation">,</span> anc_points<span class="token punctuation">,</span> gt_labels<span class="token punctuation">,</span> gt_bboxes<span class="token punctuation">,</span> mask_gt<span class="token punctuation">)</span><span class="token punctuation">:</span>
         mask_pos<span class="token punctuation">,</span> align_metric<span class="token punctuation">,</span> overlaps <span class="token operator">=</span> self<span class="token punctuation">.</span>get_pos_mask<span class="token punctuation">(</span>
            pd_scores<span class="token punctuation">,</span> pd_bboxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">,</span> gt_bboxes<span class="token punctuation">,</span> anc_points<span class="token punctuation">,</span> mask_gt
        <span class="token punctuation">)</span>

        target_gt_idx<span class="token punctuation">,</span> fg_mask<span class="token punctuation">,</span> mask_pos <span class="token operator">=</span> self<span class="token punctuation">.</span>select_highest_overlaps<span class="token punctuation">(</span>mask_pos<span class="token punctuation">,</span> overlaps<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_max_boxes<span class="token punctuation">)</span>

        <span class="token comment"># Assigned target</span>
        target_labels<span class="token punctuation">,</span> target_bboxes<span class="token punctuation">,</span> target_scores <span class="token operator">=</span> self<span class="token punctuation">.</span>get_targets<span class="token punctuation">(</span>gt_labels<span class="token punctuation">,</span> gt_bboxes<span class="token punctuation">,</span> target_gt_idx<span class="token punctuation">,</span> fg_mask<span class="token punctuation">)</span>

        <span class="token comment"># Normalize</span>
        align_metric <span class="token operator">*=</span> mask_pos
        pos_align_metrics <span class="token operator">=</span> align_metric<span class="token punctuation">.</span>amax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># b, max_num_obj</span>
        pos_overlaps <span class="token operator">=</span> <span class="token punctuation">(</span>overlaps <span class="token operator">*</span> mask_pos<span class="token punctuation">)</span><span class="token punctuation">.</span>amax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># b, max_num_obj</span>
        norm_align_metric <span class="token operator">=</span> <span class="token punctuation">(</span>align_metric <span class="token operator">*</span> pos_overlaps <span class="token operator">/</span> <span class="token punctuation">(</span>pos_align_metrics <span class="token operator">+</span> self<span class="token punctuation">.</span>eps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>amax<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        target_scores <span class="token operator">=</span> target_scores <span class="token operator">*</span> norm_align_metric

        <span class="token keyword">return</span> target_labels<span class="token punctuation">,</span> target_bboxes<span class="token punctuation">,</span> target_scores<span class="token punctuation">,</span> fg_mask<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target_gt_idx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先是<code>get_pos_mask</code>函数：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_pos_mask</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pd_scores<span class="token punctuation">,</span> pd_bboxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">,</span> gt_bboxes<span class="token punctuation">,</span> anc_points<span class="token punctuation">,</span> mask_gt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    mask_in_gts <span class="token operator">=</span> self<span class="token punctuation">.</span>select_candidates_in_gts<span class="token punctuation">(</span>anc_points<span class="token punctuation">,</span> gt_bboxes<span class="token punctuation">)</span>
    <span class="token comment"># Get anchor_align metric, (b, max_num_obj, h*w)</span>
    align_metric<span class="token punctuation">,</span> overlaps <span class="token operator">=</span> self<span class="token punctuation">.</span>get_box_metrics<span class="token punctuation">(</span>pd_scores<span class="token punctuation">,</span> pd_bboxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">,</span> gt_bboxes<span class="token punctuation">,</span> mask_in_gts <span class="token operator">*</span> mask_gt<span class="token punctuation">)</span>
    <span class="token comment"># Get topk_metric mask, (b, max_num_obj, h*w)</span>
    mask_topk <span class="token operator">=</span> self<span class="token punctuation">.</span>select_topk_candidates<span class="token punctuation">(</span>align_metric<span class="token punctuation">,</span> topk_mask<span class="token operator">=</span>mask_gt<span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>topk<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># Merge all mask to a final mask, (b, max_num_obj, h*w)</span>
    mask_pos <span class="token operator">=</span> mask_topk <span class="token operator">*</span> mask_in_gts <span class="token operator">*</span> mask_gt

    <span class="token keyword">return</span> mask_pos<span class="token punctuation">,</span> align_metric<span class="token punctuation">,</span> overlaps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后分别分析<code>select_candidates_in_gts</code>函数、<code>get_box_metrics</code>函数、<code>select_topk_candidates</code>函数分别做了什么：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">select_candidates_in_gts</span><span class="token punctuation">(</span>xy_centers<span class="token punctuation">,</span> gt_bboxes<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e-9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    n_anchors <span class="token operator">=</span> xy_centers<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    bs<span class="token punctuation">,</span> n_boxes<span class="token punctuation">,</span> _ <span class="token operator">=</span> gt_bboxes<span class="token punctuation">.</span>shape
    lt<span class="token punctuation">,</span> rb <span class="token operator">=</span> gt_bboxes<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span>chunk<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># left-top, right-bottom</span>
    bbox_deltas <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>xy_centers<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">-</span> lt<span class="token punctuation">,</span> rb <span class="token operator">-</span> xy_centers<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> n_boxes<span class="token punctuation">,</span> n_anchors<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> bbox_deltas<span class="token punctuation">.</span>amin<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>gt_<span class="token punctuation">(</span>eps<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的<code>xy_centers</code>是特征图上每个<code>gride</code>的中心点，这里叫<code>anchor</code>中心点，<code>gt_bboxes</code>中存储的是标签框的<code>(x1,y1),(x2,y2)</code>,即：左上顶点和右下顶点，如果一个点在坐标在标签框的内部，这这个点必定满足：</p>
<ul>
<li>(这个点的坐标-标签框左上顶点坐标) 的值为负值或小于小于很小的值</li>
<li>(标签框右下顶点坐标-这个点的坐标) 的值为负值或小于小于很小的值</li>
</ul>
<p>因此，这里的<code>torch.cat</code>后为$\Delta x_1,\Delta y_1,\Delta x_2,\Delta y_2$，也是维度变换后的第3维，故<code>bbox_deltas.amin(3)</code>就是求这些$\Delta$d的最小值都比很小的值大，说明这些<code>gride</code>的中心点都在标签框内。</p>
<p><mark>select_candidates_in_gts函数得到的是一个0，1矩阵，1表示对应的gride中心点在标签框内部</mark></p>
<p>然后再看<code>get_box_metrics</code>函数：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_box_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pd_scores<span class="token punctuation">,</span> pd_bboxes<span class="token punctuation">,</span> gt_labels<span class="token punctuation">,</span> gt_bboxes<span class="token punctuation">,</span> mask_gt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    na <span class="token operator">=</span> pd_bboxes<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
    mask_gt <span class="token operator">=</span> mask_gt<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># b, max_num_obj, h*w</span>
    overlaps <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_max_boxes<span class="token punctuation">,</span> na<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>pd_bboxes<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>pd_bboxes<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    bbox_scores <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_max_boxes<span class="token punctuation">,</span> na<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>pd_scores<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>pd_scores<span class="token punctuation">.</span>device<span class="token punctuation">)</span>

    ind <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>bs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_max_boxes<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span>  <span class="token comment"># 2, b, max_num_obj</span>
    ind<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>end<span class="token operator">=</span>self<span class="token punctuation">.</span>bs<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_max_boxes<span class="token punctuation">)</span>  <span class="token comment"># b, max_num_obj</span>
    ind<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> gt_labels<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># b, max_num_obj</span>
    <span class="token comment"># Get the scores of each grid for each gt cls</span>
    bbox_scores<span class="token punctuation">[</span>mask_gt<span class="token punctuation">]</span> <span class="token operator">=</span> pd_scores<span class="token punctuation">[</span>ind<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> ind<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">[</span>mask_gt<span class="token punctuation">]</span>  <span class="token comment"># b, max_num_obj, h*w</span>

    <span class="token comment"># (b, max_num_obj, 1, 4), (b, 1, h*w, 4)</span>
    pd_boxes <span class="token operator">=</span> pd_bboxes<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_max_boxes<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span>mask_gt<span class="token punctuation">]</span>
    gt_boxes <span class="token operator">=</span> gt_bboxes<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> na<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span>mask_gt<span class="token punctuation">]</span>
    overlaps<span class="token punctuation">[</span>mask_gt<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>iou_calculation<span class="token punctuation">(</span>gt_boxes<span class="token punctuation">,</span> pd_boxes<span class="token punctuation">)</span>

    align_metric <span class="token operator">=</span> bbox_scores<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>alpha<span class="token punctuation">)</span> <span class="token operator">*</span> overlaps<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>beta<span class="token punctuation">)</span>
    <span class="token keyword">return</span> align_metric<span class="token punctuation">,</span> overlaps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先要知道这里使用的读了指标的计算公式，根据代码可以看出计算公式如下：<br>$$<br>metric&#x3D;box_score^{\alpha}*IoU^{\beta}<br>$$<br>这里似乎是综合考虑了网络预测框的置信度和预测框与标签框的IoU值来得到框的预测精度指标，那么为什么这么做：</p>
<p>在目标检测中，匹配正负样本时，如果只看 <strong>IoU</strong>：</p>
<ul>
<li>可能选到和 GT 位置重叠高，但box预测分数很低或错误的框。</li>
</ul>
<p>如果只看 <strong>分类得分</strong>：</p>
<ul>
<li>可能box预测分数高，但位置和 GT 偏差很大的框。</li>
</ul>
<p>所以，需要一个 <strong>同时考虑分类和定位的指标</strong>，这就是 alignment metric。</p>
<ul>
<li><p>当 $\alpha &gt; 1$：box预测准确性占比更大，弱化了 IoU 的影响。</p>
</li>
<li><p>当 $\alpha &lt; 1$：放大了低box预测分数的影响，减少box预测偏差对匹配的负面作用。</p>
</li>
<li><p>当 $\beta &gt; 1$：更强调定位精度（IoU 高的框更容易被选中）。</p>
</li>
<li><p>当 $\beta &lt; 1$：允许 IoU 不高但box预测分数高的框被选中。</p>
</li>
</ul>
<p>在实际代码中：$\alpha&#x3D;0.5,\beta&#x3D;6.0$，这就说明这里更加强调使用IoU作为预测精度的评估，但如果IoU很小，预测框的分数很高的情况下这个匹配分数不至于太低。至于这里使用二者指标的乘积是为了让任意一个指标近乎为0是，最终的匹配分数也接近0。</p>
<p>然后再来看下<code>align_metric</code>和<code>overlaps</code>中都存储了什么，它们的维度为[batch_size,n_max_boxes,num_anchors]，也就是说他们存储了n_max_boxes个标签框在每个位置(gride)的匹配分数(align_metric)和该位置(gride)预测框与标签框的iou分数(overlaps)，当然对于无效预测框和无效标签框的位置这些值都是0。</p>
<p><mark>get_box_metrics函数得到的是标签框在对应预测位置的精度值：IoU和匹配分数</mark></p>
<p>最后看<code>select_topk_candidates</code>函数：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">select_topk_candidates</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> metrics<span class="token punctuation">,</span> topk_mask<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># (b, max_num_obj, topk)</span>
    topk_metrics<span class="token punctuation">,</span> topk_idxs <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>metrics<span class="token punctuation">,</span> self<span class="token punctuation">.</span>topk<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> largest<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> topk_mask <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        topk_mask <span class="token operator">=</span> <span class="token punctuation">(</span>topk_metrics<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> self<span class="token punctuation">.</span>eps<span class="token punctuation">)</span><span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>topk_idxs<span class="token punctuation">)</span>
    <span class="token comment"># (b, max_num_obj, topk)</span>
    topk_idxs<span class="token punctuation">.</span>masked_fill_<span class="token punctuation">(</span><span class="token operator">~</span>topk_mask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token comment"># (b, max_num_obj, topk, h*w) -> (b, max_num_obj, h*w)</span>
    count_tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int8<span class="token punctuation">,</span> device<span class="token operator">=</span>topk_idxs<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    ones <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>topk_idxs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int8<span class="token punctuation">,</span> device<span class="token operator">=</span>topk_idxs<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
    <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>topk<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Expand topk_idxs for each value of k and add 1 at the specified positions</span>
        count_tensor<span class="token punctuation">.</span>scatter_add_<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> topk_idxs<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> k <span class="token punctuation">:</span> k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ones<span class="token punctuation">)</span>
    <span class="token comment"># Filter invalid bboxes</span>
    count_tensor<span class="token punctuation">.</span>masked_fill_<span class="token punctuation">(</span>count_tensor <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> count_tensor<span class="token punctuation">.</span>to<span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先看下如果<code>count_tensor[b_idx, obj_idx, anchor_idx] = 1</code>表示什么意思？这表示这个<code>batch</code>中 第 <code>b_idx</code> 张图像的第 <code>obj_idx</code> 个目标中<code>anchor_idx</code> 对应的 <code>gride</code> 被选为 <code>top-k</code> 候选。因此这里就是挑选哪些gride是有对应标定框的，挑选的topk指标就是前面计算的匹配分数。<code>torch.topk</code>中指定了对最后一个维度进行挑选，也就是说这里是为每个标签框选中匹配分数最大的topk个gride.，因此<code>topk_metrics, topk_idxs</code>的维度均为<code>[batch_size,n_max_boxes,topk]</code>,也就是得到了每张图<code>n_max_boxes</code>个框，每个框<code>topk</code>个位置(gride)。</p>
<p>这个挑选首先在<code>count_tensor.scatter_add_(-1, topk_idxs[:, :, k : k + 1], ones)</code>这里可以看到，这里是对<code>topk_idxs</code> 指定的索引位置做<code>+1</code>,那么<code>topk_idxs</code>中是什么东西？首先看&#96;&#96;topk_idxs<code>的维度:[batch_size,n_max_boxes,topk]，即：</code>topk_idxs<code>中存储了batch_size张图像，每张图像最多n_max_boxes个标签框，每个标签框选定的topk个gride索引，其实就是有效标签框中心的topk个最大可能位置。之所以说是有效位置是因为这里是最多3个标签框，实际有几个要看</code>topk_mask&#96;如何指定哪些是有效的。</p>
<p><code>count_tensor</code>中如果一个索引处的值为n，说明这个gride在某个标签框下被选中了n次数，换句话说就是这个位置是多个标签框的中心，这种情况下作者的处理是直接舍弃这些位置(gride)。感觉有点暴力，如果两个标签框对应的topk个gride不是完全重复的情况下，每个标签框还会留下几个gride，但是如果两个标签框的topk个gride完全重复，此时会直接让这两个标签框都没有gride,或者说刚好是匹配分数最大的那几个gride出现重复，这个标签框会失去最大可能性的位置。这里目前先存疑….，直接来看下这样的暴力操作有什么好处：</p>
<ul>
<li>保证训练 loss 的 <strong>明确性</strong>。</li>
<li>避免梯度冲突。</li>
<li>避免同一 gride 对多个 gt 的重复惩罚。</li>
<li>对 anchor-free 方法来说，每个 grid 只预测一个类别的 gt box 是自然约束</li>
</ul>
<p><mark>select_topk_candidates返回了一个存储了对于每个标签框对应的gride为正负样本的0-1张量</mark></p>
<p>现在回到<code>get_pos_mask</code>函数：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">mask_pos <span class="token operator">=</span> mask_topk <span class="token operator">*</span> mask_in_gts <span class="token operator">*</span> mask_gt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>mask_pos存储了所有正样本的索引，且<strong>正样本需要同时满足以下三个条件</strong>：</p>
<ul>
<li>这个<code>gride</code>在标签框的topk中<code>mask_topk[,,,]=1</code></li>
<li>这个<code>gride</code>在有对应的标签框内<code>mask_in_gts[,,,]=1</code></li>
<li>这个<code>gride</code>对应的标签框是有效的<code>mask_gt,,,[]=1</code></li>
</ul>
<p><mark>get_pos_mask返回正样本gride的索引和所有gride的匹配分数和IoU</mark></p>
<p>至此我们已经得到每个标签框对应的的topk个匹配分数最大的位置，现在需要确定哪个位置才是最终标签框的位置，这里选择IoU最大的位置作为最终的标签框的位置，实现方法由函数<code>select_highest_overlaps</code>实现的，此函数的输入和输出如下所示：</p>
<ul>
<li>输入</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>类型</th>
<th>形状</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>mask_pos</code></td>
<td><code>torch.Tensor</code></td>
<td><code>[b, n_max_boxes, h*w]</code></td>
<td>初始正样本 mask，存储每个目标框的topk个gride位置信息</td>
</tr>
<tr>
<td><code>overlaps</code></td>
<td><code>torch.Tensor</code></td>
<td><code>[b, n_max_boxes, h*w]</code></td>
<td>预测框与标签框的iou分数</td>
</tr>
<tr>
<td><code>n_max_boxes</code></td>
<td><code>int</code></td>
<td><code>-</code></td>
<td>每个图像最大标签框数量，取值为当前batch中每张图中最多的标签框个数</td>
</tr>
</tbody></table>
<p>然后看第1个关键代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">max_overlaps_idx <span class="token operator">=</span> overlaps<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>overlaps</code>的维度为<code>[batch_size,n_max_boxes,grides]</code>,因此第一个维度为标签框的索引，这里对这个维度取最大值的意思解释如下：</p>
<p>比如<code>n_max_boxes=2</code>，<code>grides=4725</code>，意思是每个标签框有<code>4725</code>个预测位置与之对应，其<code>iou</code>分数存储在<code>overlaps</code>中，那么按照<code>n_max_boxes</code>所在的维度取最大值后这个维度就会变为1，即<code>max_overlaps_idx</code>的维度为<code>[batch_size,n_max_boxes,grides]</code>，此时<code>max_overlaps_idx</code>中存储的是框的id，即4725个位置中每个位置都对应了3个框，现在把iou最大的那个框的<code>id</code>取出来存储在<code>max_overlaps_idx</code>。因此<code>max_overlaps_idx</code>就是以<code>iou</code>为指标，为每个位置分配一个最大可能性的框。</p>
<p>然后看第2个关键代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">fg_mask <span class="token operator">=</span> mask_pos<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>mask_pos</code>中存储了正样本的位置信息，即：每个标签框最多topk(排序指标为匹配分数)个满足条件的(位置在标签框区域内、标签框有效)预测位置，因此这里沿着倒数第二个维度进行进行求和就相当于n_max_boxes个正样本的位置信息对应相加，得到的是每个正样本位置处标签框的个数，数值越大说明对应位置出现标签框的次数越多，因此fg_mask其实可以作为前景区域的mask。</p>
<p>然后看第3个关键代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">is_max_overlaps<span class="token punctuation">.</span>scatter_<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> max_overlaps_idx<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
mask_pos <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>mask_multi_gts<span class="token punctuation">,</span> is_max_overlaps<span class="token punctuation">,</span> mask_pos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># (b, n_max_boxes, h*w)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>第一行的意思是在is_max_overlaps的第1维度上将max_overlaps_idx不为0的位置写1，其实得到一个[batch_size,n_max_boxes,grides]的张量对每个框具有最大iou的位置至1。</p>
<p>然后看第4个关键代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">mask_multi_gts <span class="token operator">=</span> <span class="token punctuation">(</span>fg_mask<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> n_max_boxes<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果有个位置不止一个标签框，就将这些位置置1，其他位置为0，说白了如果一个位置有多个标签框，我们就要选择合适的那个，这里mask_multi_gts就标记了哪里不合适，然后就是不合适的位置是否要保留：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">mask_pos <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>mask_multi_gts<span class="token punctuation">,</span> is_max_overlaps<span class="token punctuation">,</span> mask_pos<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果一个位置(mask_multi_gts)存在多一个标签框(fg_mask.unsqueeze(1) &gt; 1),就分如下情况处理：</p>
<ul>
<li>这个位置是只能是具有最大iou的那个标签框的(max_overlaps_idx)，比如对于第1000个gride位置，同时是第0、1、2个标签框的正样本位置，那么第1000个gride位置只能属于具有最大iou那个标签框，假设是第0个标签框，那么其他框的第1000个gride位置都置0。</li>
<li>如果这个位置只有一个标签框预期对应，那就不修改</li>
</ul>
<p>再看最后1个关键代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">target_gt_idx <span class="token operator">=</span> mask_pos<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>mask_pos中存储了所有标签框的唯一正样本位置，这里沿着倒数第2个维度取最大值，取到的就是一堆标签框的索引值，即某个gride位置是哪个框的正样本。</p>
<p>综上我们可以得到select_highest_overlaps的输出都是什么含义：</p>
<ul>
<li>输出</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>形状</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>target_gt_idx</code></td>
<td><code>[b, h*w]</code></td>
<td>更新后的正样本对应的最终分配的标签框的索引</td>
</tr>
<tr>
<td><code>fg_mask</code></td>
<td><code>[b, h*w]</code></td>
<td>前景 mask，存储每个 gride处正样本的个数</td>
</tr>
<tr>
<td><code>mask_pos</code></td>
<td><code>[b, n_max_boxes, h*w]</code></td>
<td>更新后的正样本 mask，一个标签框对应唯一一个具有最大统计指标的gride位置</td>
</tr>
</tbody></table>
<p><mark>select_highest_overlap函数就是以最大iou为依据使得每个标签的正样本位置存在且唯一</mark></p>
<p>现在已经得到了真正的正样本位置，接下来就要确定正样本的标签框的位置和类别，这些在<code>get_targets</code>函数中实现：</p>
<p>这里的<code>target_labels, target_bboxes</code>很容易理解就是每个正样本位置的标签框的类别<code>id</code>和位置<code>xyxy</code>：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">batch_ind <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>end<span class="token operator">=</span>self<span class="token punctuation">.</span>bs<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> device<span class="token operator">=</span>gt_labels<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>
target_gt_idx <span class="token operator">=</span> target_gt_idx <span class="token operator">+</span> batch_ind <span class="token operator">*</span> self<span class="token punctuation">.</span>n_max_boxes  <span class="token comment"># (b, h*w)</span>
target_labels <span class="token operator">=</span> gt_labels<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>target_gt_idx<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p><code>batch_ind=[0,1,2,3,...,batch_size-1]</code>,维度为<code>[batch_size,1]</code></p>
</li>
<li><p><code>batch_ind * self.n_max_boxes=[0,n_max_boxes,2*n_max_boxes,3*n_max_boxes,...,(batch_size-1)*n_max_boxes]</code>,维度为<code>[batch_size,1]</code></p>
</li>
<li><p><code>target_gt_idx</code>的维度为<code>[batch_size,h*w]</code>，最终的<code>target_gt_idx</code>的每个<code>batch</code>分别加上一个固定值得到。<code>target_gt_idx</code>中为每个正样本<code>gride</code>对应标签框序号，即：第几个标签框，也就是说如果这个正样本是第<code>n</code>个<code>batch</code>的，对应的标签框序号需要统一加上<code>n-1</code>,为什么要这样？</p>
</li>
<li><p><code>gt_labels</code>的维度为<code>[batch_size,n_max_boxes,1]</code>,这里存储了目标框的类别<code>ID</code>，经过<code>flatten()</code>展平后$[ID^0_{box_0},ID^0_{box_1},ID^0_{box_2},…,ID^0_{box_{max}},…,ID^{b-1}<em>{box_0},ID^{b-1}</em>{box_1},ID^1_{box_2},…,ID^{b-1}<em>{box</em>{max}}]$，长度为<code>batch_size*n_max_boxes</code>，其实就是依次存储了所有batch的n_max_boxes个标签的类别ID</p>
</li>
</ul>
<p>这里是高级索引，首先距离解释一下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">gt_labels_flat <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">22</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
target_gt_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># shape [2,2]</span>

gt_labels_flat<span class="token punctuation">[</span>target_gt_idx<span class="token punctuation">]</span>
<span class="token comment"># tensor([[10,12],</span>
<span class="token comment">#         [21,20]])</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就明白了，从gt_labels中取ID的时候，第一个bacth的无需向后偏移，第2个batch的就需要向后偏移n_max_boxes,依次类推。</p>
<p>因此<code>target_labels</code>中存储的是所有batch中正样本gride对应的标签类别ID。同理<code>target_bboxes</code>中存储的是所有batch中正样本gride对应的标签框位置<code>xyxy</code>。</p>
<p>但是这里的<code>target_scores</code>需要解释一下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">target_scores <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>
    <span class="token punctuation">(</span>target_labels<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> target_labels<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span><span class="token punctuation">,</span>
    dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span>
    device<span class="token operator">=</span>target_labels<span class="token punctuation">.</span>device<span class="token punctuation">,</span>
<span class="token punctuation">)</span>  <span class="token comment"># (b, h*w, 80)</span>
target_scores<span class="token punctuation">.</span>scatter_<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> target_labels<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里首先将<code>target_scores</code>初始化为全0张量，然后沿着维度2将正样本位置置1，<code>target_scores</code>的维度为<code>[batch_size,n_max_boxes,1]</code>且目标正样本对应的分数都是1。而下面的代码是防御性编程，确保每个正样本必须属于前景区域：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">fg_scores_mask <span class="token operator">=</span> fg_mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_classes<span class="token punctuation">)</span>  <span class="token comment"># (b, h*w, 80)</span>
target_scores <span class="token operator">=</span> torch<span class="token punctuation">.</span>where<span class="token punctuation">(</span>fg_scores_mask <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> target_scores<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>因此，这里的target_scores是一个0-1张量或者叫one-hot标签，是说每个gride的预测分数是否有效。还并没有得到具体的分数值，下面我们就继续看如何得到分数值的：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">align_metric <span class="token operator">*=</span> mask_pos
pos_align_metrics <span class="token operator">=</span> align_metric<span class="token punctuation">.</span>amax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># b, max_num_obj</span>
pos_overlaps <span class="token operator">=</span> <span class="token punctuation">(</span>overlaps <span class="token operator">*</span> mask_pos<span class="token punctuation">)</span><span class="token punctuation">.</span>amax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># b, max_num_obj</span>
norm_align_metric <span class="token operator">=</span> <span class="token punctuation">(</span>align_metric <span class="token operator">*</span> pos_overlaps <span class="token operator">/</span> <span class="token punctuation">(</span>pos_align_metrics <span class="token operator">+</span> self<span class="token punctuation">.</span>eps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>amax<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
target_scores <span class="token operator">=</span> target_scores <span class="token operator">*</span> norm_align_metric<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>第1行是匹配分数的挑选，只保留正样本的匹配分数</p>
</li>
<li><p>第2行是将匹配分数沿着最后一个维度取最大值，得到的每个标签框对应最大匹配分数,<code>pos_align_metrics</code>的维度为[batch_size,n_max_boxes,1]</p>
</li>
<li><p>第3行同理，<code>pos_overlaps</code>为每个标签框对应最大IoU分数维度为[batch_size,n_max_boxes,1]</p>
</li>
<li><p>第4行首先看，这是一个公式：<br>$$<br>norm_align_metric&#x3D;\frac{align_metric * pos_overlaps}{pos_align_metrics + self.eps}<br>$$</p>
</li>
</ul>
<p>$$<br>norm_align_metric&#x3D;\frac{匹配分数 * IoU}{最大匹配分数 + 很小的数}<br>$$</p>
<ul>
<li>现在来看第4行，这个就是一种归一化，对匹配分数和IoU的乘积进行归一化，然后取了标签框对应的正样本中最大的归一化分数作为所有正样本的归一化分数</li>
<li>第5行得到的是最终的归一化的标签框的匹配分数</li>
</ul>
<p>这里有个疑惑，经过select_highest_overlaps函数后所有的正样本将指挥保留具有最大iou的正样本，那么这里的第2，3，4行都使用了<code>amax</code>都是对一个值取最大值，这有什么意义？似乎只是为了降维，将最后一维从<code>h*w</code>降维至<code>1</code>。最后我们得到了如下的正样本筛选结果：</p>
<table>
<thead>
<tr>
<th align="center">变量</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>target_labels</code></td>
<td align="center">所有batch中每个标签对应的预测框的类别ID</td>
</tr>
<tr>
<td align="center"><code>target_bboxes</code></td>
<td align="center">所有batch中每个标签对应的预测框的位置<code>xyxy</code></td>
</tr>
<tr>
<td align="center"><code>target_scores</code></td>
<td align="center">所有batch中每个标签对应的预测框的匹配分数</td>
</tr>
<tr>
<td align="center"><code>fg_mask</code></td>
<td align="center">具有最大iou的正样本mask</td>
</tr>
<tr>
<td align="center"><code>target_gt_idx</code></td>
<td align="center">具有最大iou的正样本对应的标签框的序号</td>
</tr>
</tbody></table>
<h3 id="class-loss"><a href="#class-loss" class="headerlink" title="class  loss"></a>class  loss</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">loss<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>bce<span class="token punctuation">(</span>pred_scores<span class="token punctuation">,</span> target_scores<span class="token punctuation">.</span>to<span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> target_scores_sum  <span class="token comment"># BCE</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>类别的损失计算方法是<code>nn.BCEWithLogitsLoss</code>,计算方法如下：</p>
<p>假设：</p>
<ul>
<li>$\hat{y} \in (0, 1)$：模型预测的概率（<strong>已经经过 Sigmoid 函数</strong>）</li>
<li>$y \in {0, 1}$：真实标签（0 或 1）</li>
</ul>
<p>那么 BCELoss 的公式是：<br>$$<br>\text{BCELoss}(\hat{y}, y) &#x3D; -[y \cdot \log(\hat{y}) + (1 - y) \cdot \log(1 - \hat{y})]<br>$$</p>
<blockquote>
<p>注意：输入必须是概率（0~1 之间），即通常需要先用 <code>sigmoid</code>。</p>
</blockquote>
<p>但是这里的预测类别分数并没有进行归一化，而是得到所有正样本的类别bce loss之和后除以所有标签框的匹配分数之和(<code>target_scores_sum</code>)进行了类似的归一化。</p>
<p>然后我们再分析一下什么时候才会计算类别损失：</p>
<ul>
<li>首先，计算<code>class loss</code>前并没有显式的if语句进行控制</li>
<li>然后，需要看下什么时候<code>class loss</code>为0，从公式上来看就是<code>target_scores_sum=0</code>，那么什么时候<code>target_scores_sum=0</code>。如果所有gride中的预测框都没有匹配到标签框，此时<code>target_scores_sum=0</code>,也就是说全是负样本，没有正样本。</li>
</ul>
<p>因此只有正样本才会计算<code>class loss</code>。</p>
<h3 id="box-loss"><a href="#box-loss" class="headerlink" title="box loss"></a>box loss</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># Bbox loss</span>
        <span class="token keyword">if</span> fg_mask<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            target_bboxes <span class="token operator">/=</span> stride_tensor
            loss<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> loss<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>bbox_loss<span class="token punctuation">(</span>
                pred_distri<span class="token punctuation">,</span> pred_bboxes<span class="token punctuation">,</span> anchor_points<span class="token punctuation">,</span> target_bboxes<span class="token punctuation">,</span> target_scores<span class="token punctuation">,</span> target_scores_sum<span class="token punctuation">,</span> fg_mask
            <span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先，这里可以看出之前存在前景目标(fg_mask.sum()!&#x3D;0)的才会计算<code>Bbox loss</code>，然后看下具体如何计算：这里的box预测损失使用了<code>BboxLoss</code>方法，该方法的实现细节如下:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ultralytics/utils/loss.py</span>
<span class="token keyword">class</span> <span class="token class-name">BboxLoss</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Criterion class for computing training losses for bounding boxes."""</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reg_max<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize the BboxLoss module with regularization maximum and DFL settings."""</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dfl_loss <span class="token operator">=</span> DFLoss<span class="token punctuation">(</span>reg_max<span class="token punctuation">)</span> <span class="token keyword">if</span> reg_max <span class="token operator">></span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token boolean">None</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span><span class="token comment"># ......省略无关代码......)</span>
        <span class="token comment"># ......省略无关代码......</span>
        weight <span class="token operator">=</span> target_scores<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span>fg_mask<span class="token punctuation">]</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        iou <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>pred_bboxes<span class="token punctuation">[</span>fg_mask<span class="token punctuation">]</span><span class="token punctuation">,</span> target_bboxes<span class="token punctuation">[</span>fg_mask<span class="token punctuation">]</span><span class="token punctuation">,</span> xywh<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        loss_iou <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou<span class="token punctuation">)</span> <span class="token operator">*</span> weight<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> target_scores_sum

        <span class="token comment"># DFL loss</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>dfl_loss<span class="token punctuation">:</span>
            target_ltrb <span class="token operator">=</span> bbox2dist<span class="token punctuation">(</span>anchor_points<span class="token punctuation">,</span> target_bboxes<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dfl_loss<span class="token punctuation">.</span>reg_max <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
            loss_dfl <span class="token operator">=</span> self<span class="token punctuation">.</span>dfl_loss<span class="token punctuation">(</span>pred_dist<span class="token punctuation">[</span>fg_mask<span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>dfl_loss<span class="token punctuation">.</span>reg_max<span class="token punctuation">)</span><span class="token punctuation">,</span> target_ltrb<span class="token punctuation">[</span>fg_mask<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> weight
            loss_dfl <span class="token operator">=</span> loss_dfl<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> target_scores_sum
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            loss_dfl <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>pred_dist<span class="token punctuation">.</span>device<span class="token punctuation">)</span>

        <span class="token keyword">return</span> loss_iou<span class="token punctuation">,</span> loss_dfl
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看出box_loss就是加权IoU损失，IoU的计算方法使用了CIoU,权重为所有标签框的匹配分数之和。其中<code>pred_bboxes</code>为所有gride的预测框，<code>pred_bboxes[fg_mask]</code>为最终挑选的前景正样本的gride的预测框。同时对loss_iou除以所有标签框的匹配分数之和(target_scores_sum)进行了归一化。</p>
<p>CIoU的计算方法参见:<a href="#IOU(%E4%BA%A4%E5%B9%B6%E6%AF%94%E6%8D%9F%E5%A4%B1)">CIoU</a></p>
<h3 id="dfl-loss"><a href="#dfl-loss" class="headerlink" title="dfl loss"></a>dfl loss</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># DFL loss</span>
<span class="token keyword">if</span> self<span class="token punctuation">.</span>dfl_loss<span class="token punctuation">:</span>
    target_ltrb <span class="token operator">=</span> bbox2dist<span class="token punctuation">(</span>anchor_points<span class="token punctuation">,</span> target_bboxes<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dfl_loss<span class="token punctuation">.</span>reg_max <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    loss_dfl <span class="token operator">=</span> self<span class="token punctuation">.</span>dfl_loss<span class="token punctuation">(</span>pred_dist<span class="token punctuation">[</span>fg_mask<span class="token punctuation">]</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>dfl_loss<span class="token punctuation">.</span>reg_max<span class="token punctuation">)</span><span class="token punctuation">,</span> target_ltrb<span class="token punctuation">[</span>fg_mask<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> weight
    loss_dfl <span class="token operator">=</span> loss_dfl<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> target_scores_sum
<span class="token keyword">else</span><span class="token punctuation">:</span>
    loss_dfl <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>pred_dist<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里可以看出dfl loss的权重和归一化方法与box loss一样，具体的DFL loss计算方法参见：[dls loss](#DFL loss(分布式焦点损失))</p>
<h3 id="损失加权计算"><a href="#损失加权计算" class="headerlink" title="损失加权计算"></a>损失加权计算</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ultralytics/utils/loss.py</span>
<span class="token keyword">class</span> <span class="token class-name">v8DetectionLoss</span><span class="token punctuation">:</span>
     <span class="token comment"># ......省略无关代码......</span>
	<span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> batch<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Tuple<span class="token punctuation">[</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">:</span>
         <span class="token comment"># ......省略无关代码......</span>
        loss<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">.</span>box  <span class="token comment"># box gain</span>
        loss<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">.</span>cls  <span class="token comment"># cls gain</span>
        loss<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">.</span>dfl  <span class="token comment"># dfl gain</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中<code>box gain</code>、<code>cls gain</code>和<code>dfl gain</code>的值配置如下所示：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># ultralytics/cfg/default.yaml</span>
<span class="token key atrule">box</span><span class="token punctuation">:</span> <span class="token number">7.5</span> <span class="token comment"># (float) box loss gain</span>
<span class="token key atrule">cls</span><span class="token punctuation">:</span> <span class="token number">0.5</span> <span class="token comment"># (float) cls loss gain (scale with pixels)</span>
<span class="token key atrule">dfl</span><span class="token punctuation">:</span> <span class="token number">1.5</span> <span class="token comment"># (float) dfl loss gain</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="YOLO-V5系列"><a href="#YOLO-V5系列" class="headerlink" title="YOLO-V5系列"></a>YOLO-V5系列</h1><h2 id="v5ComputeLoss"><a href="#v5ComputeLoss" class="headerlink" title="v5ComputeLoss"></a>v5ComputeLoss</h2><p>首先给出目标检测算法的loss，计算公式如下：<br>$$<br>loss&#x3D;batchSize * (boxLoss<em>A+objLoss</em>B+classLoss*C)<br>$$<br>其中A,B,C为各个损失的权重</p>
<p>yolo训练时使用三个输出，三个输出为不同尺寸特征图，即：不同大小anchor的检测结果</p>
<p>评估时使用一个输出，合并不同anchor的检测结果，缩放到原图尺寸进行输出</p>
<p>因此，训练时计算的loss时循环计算了所有anchor下的所有推理box的损失，对应代码如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># predictions, targets</span>
    lcls <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># class loss</span>
    lbox <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># box loss</span>
    lobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># object loss</span>
    tcls<span class="token punctuation">,</span> tbox<span class="token punctuation">,</span> indices<span class="token punctuation">,</span> anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>build_targets<span class="token punctuation">(</span>p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>  <span class="token comment"># targets</span>
    <span class="token comment"># Losses</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> pi <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># layer index, layer predictions</span>
        b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># image, anchor, gridy, gridx</span>
        tobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>pi<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>pi<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># target obj</span>
        n <span class="token operator">=</span> b<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># number of targets</span>
        <span class="token keyword">if</span> n<span class="token punctuation">:</span>
            pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">,</span> _<span class="token punctuation">,</span> pcls <span class="token operator">=</span> pi<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># target-subset of predictions</span>
            <span class="token comment"># Regression</span>
            pxy <span class="token operator">=</span> pxy<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">0.5</span>
            pwh <span class="token operator">=</span> <span class="token punctuation">(</span>pwh<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中<code>for i, pi in enumerate(p): </code>就是访问不同尺寸特征图下的预测结果，yolo默认为3个分支，其中：<code>i</code>表示对应层的序号，<code>pi</code>表示该层的预测结果。</p>
<ul>
<li><p><code>pxy</code>为<code>特征图尺度下</code>预测框在中心点相对于<code>gride</code>左上角的偏移量</p>
</li>
<li><p><code>pwh</code>为<code>特征图尺度下</code>预测框的宽度</p>
<p>然后我们分析一下<code>pxy</code>和<code>pwh</code>的范围：</p>
<p><img src="https://cdn.jsdelivr.net/gh/geiyiren/MyBlogImage1/yolo%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%AE%97%E6%B3%95%E4%B9%8B%E6%8D%9F%E5%A4%B1%E8%AE%A1%E7%AE%97/sigmoid-1757560625430-3.png" alt="sigmoid"></p>
<p>通过这个图像可以看出:</p>
<ul>
<li>$pxy \in [0.5,1.5]$</li>
<li>$pwh \in [0,4]*anchor$</li>
</ul>
</li>
</ul>
<h3 id="box-loss-1"><a href="#box-loss-1" class="headerlink" title="box loss"></a>box loss</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python">iou <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>pbox<span class="token punctuation">,</span> tbox<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>通过这一行源码可以看出yolov5默认使用CIoU进行预测框的损失计算</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">lbox <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>通过这一行源码可以看出yolov5将每一张图像的所有预测框的iou求了均值作为该图像的目标框推理损失，因为一个图像中可能有多个目标。</p>
<p>模型推理的时候batch size设置为256，那么同时会推理256张图像的，也就是说这里的iou是当前batch的256张图像同时推理得到结果进行求均值得到的标量<code>lbox</code>。那这里可能就是batch size对训练影响的源头：</p>
<ul>
<li><p>推理单张图：</p>
<ul>
<li><p>每个预测框直接计算 IoU&#x2F;score</p>
</li>
<li><p>loss 或指标只针对该图</p>
</li>
<li><p>输出更直观，能看到单图性能</p>
</li>
</ul>
</li>
<li><p>batch 训练：</p>
<ul>
<li>平均到整个 batch</li>
<li>对应梯度是 batch 上的整体平均</li>
<li>优势是稳定和高效，缺点是掩盖单图差异，可以避免极端目标的loss对梯度的回传造成影响</li>
</ul>
</li>
</ul>
<p>再看<code>bbox_iou</code>函数的输入数据是什么样子的：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">bbox_iou</span><span class="token punctuation">(</span>box1<span class="token punctuation">,</span> box2<span class="token punctuation">,</span> xywh<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> GIoU<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> DIoU<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e-7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Returns Intersection over Union (IoU) of box1(1,4) to box2(n,4)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>可以看出这里如果预测框有一个，但是标签框就是多个，也就是说预测框会和所有适合该分支的标签框(后面说明如何为每个分支挑选合适的标签框…)进行Iou计算，漏检和误检的iou会是0，box loss就会比较大。实际每个分支不会只预测一个框，也就是说box1的维度为(m,4),box2的维度为(n,4)，得到的iou的维度为(m,n)。</p>
<p><strong>yolo为了不同的分支可以预测不同尺度的目标，他是怎么通过loss实现的？</strong></p>
<p>首先需要将标签框转换到不同的尺寸，然后根据大小为不同分支分配不同的标签框用于计算损失，具体方法可以分为：尺度变化和标签分配：</p>
<hr>
<h4 id="尺度变换"><a href="#尺度变换" class="headerlink" title="尺度变换"></a>尺度变换</h4><p>这里还有一个疑问，特征图其实不是图，也就是是说特征图上不能直接绘制目标框，也不是原图缩放指定倍率后得到的缩放图，而是一个多维张量，其中存贮了想要的预测结果。那yolo为什么要将标签框映射到不同的特征图尺寸下进行box loss计算，其实这里特征图的w,h不仅仅表示预测框的个数，也表示网格尺寸。特征图像的shape为(batch, anchors_per_cell, grid_h, grid_w, channels)，那么对于任意输入的一张待检测图像而言，可以得到的框的个数为<code>anchors_per_cell * grid_h * grid_w</code>，而每个框的参数为<code>channels</code>个，一般包括<code>x,y,w,h,box_score,label_1_scoer,...</code>。</p>
<p>另一方面，yolo的设计初衷是为了让不同的分支得到不同尺度的预测框，这个尺度和分支的配合就是通过loss来控制的，前面的分支进行小目标检测，后面的分支进行大目标检测。</p>
<blockquote>
<p>…为什么小目标要在前面的分支进行计算？每次降采样其实是对特征的融合，比如开始时图像为480*288，物体站中间的64x64个像素，随着降采样，这64x64个像素逐渐变为8x8，然后逐级变小，甚至不足1x1，后面的分支获得来自物体所在区域的像素特征的影响越来越少，但获得来自全局的信息越来越多(这就是感受野变大了)。当然每次降采样不是简单的使用类似均值这样的直观特征进行简化物体特征的，而是一个可以学习的矩阵参数，这些参数将在训练过程中逐渐生成。换句话说，降采样就是将图像矩阵按照指定的步长和一个可以学习的卷积核进行卷积操作。那么随着降采样的不断进行，后面分支的特征图中存储的来自物体本身的像素信息越来越少，因此才要使用降采样倍率低的特征图像预测小目标，因为这里可以更多的获得物体本身的信息。</p>
</blockquote>
<p>那么这里的grid_h * grid_w也可以被认为是图像的大小，可以理解为在尺寸为grid_h * grid_w的图像上绘制目标框，以特征图像上的每个’’像素”为框的左上角，绘制若干个大小不一的框，这些框中都以一定的概率框中目标，这个概率就是box score。后面的分支特征图越来越小，每两个”像素”之间的距离在原图上的对应距离也越远了，此时绘制框也要更大，要不绘制框的个数有限的情况下，所有的框无法覆盖整个图像，也就是说框会很稀疏，会有很多地方没有框，因此后面的分支特征图在变小，anchor框的尺寸在增大。</p>
<blockquote>
<p>注意这里的anchor已经被缩放了，模型训练的时候给的anchor是相对于输入图像的，这里需要缩放到对应特征图上进行绘制。</p>
</blockquote>
<p>这里看下代码中是如何对目标框进行缩放的：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">build_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token comment">#省略无关代码</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>nl<span class="token punctuation">)</span><span class="token punctuation">:</span>
            anchors<span class="token punctuation">,</span> shape <span class="token operator">=</span> self<span class="token punctuation">.</span>anchors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape
            gain<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>shape<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span>  <span class="token comment"># xyxy gain</span>

            <span class="token comment"># Match targets to anchors</span>
            t <span class="token operator">=</span> targets <span class="token operator">*</span> gain  <span class="token comment"># shape(3,n,7)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的<code>self.anchors[i]</code>是对应特征尺度下的anchor,<code>shape</code>为对应分支特征图的尺寸，第2维为$w$,第三维为$h$,<code>gain[2:6]</code>中存储的是标签框的$[x,y,w,h]$的缩放系数: 特征图的$[w,h,w,h]$，即：$x,w$缩放倍数为特征图的$w$，$y,h$缩放倍数为特征图的$h$。这样得到的<code>t[..., 4:6]</code>就是标签框在特征图尺度下的$w,h$。</p>
<p><mark><code>t = targets * gain</code>得到特征图尺寸下的标签框的<code>x,y,w,h</code></mark></p>
<hr>
<h4 id="标签分配-1"><a href="#标签分配-1" class="headerlink" title="标签分配"></a>标签分配</h4><p>在<code>loss.py</code>的<code>build_targets</code>函数中将标签坐标转换为不同的anchor中，便于后面与不同分支的各个anchor对应的框进行IoU计算，其实没有匹配过程，这里是是直接计算的匹配损失，即一个检测框和所有标签框计算损失，然后求平均得到这个batch的损失，那么漏检和误检在这里计算的IOU都为0。那如果全为漏检，则iou为0,如果全为误检，那么iou也为0，二者对损失的贡献是相同的。</p>
<p>在<code>build_targets</code>也做了对应的过滤，方法如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">build_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 省略不相关代码</span>
    <span class="token comment"># Matches</span>
    r <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">/</span> anchors<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># wh ratio</span>
    j <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">/</span> r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'anchor_t'</span><span class="token punctuation">]</span>  <span class="token comment"># compare</span>
    <span class="token comment"># j = wh_iou(anchors, t[:, 4:6]) > model.hyp['iou_t']  # iou(3,n)=wh_iou(anchors(3,2), gwh(n,2))</span>
    t <span class="token operator">=</span> t<span class="token punctuation">[</span>j<span class="token punctuation">]</span>  <span class="token comment"># filter</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>标签框的尺寸大于<code>anchor</code>的尺寸，$r&gt;1&#x2F;r$，条件为：<br>$$<br>r&lt;anchor_t \\<br>\frac{label_{wh}}{anchor_{wh}}&lt;anchor_t \\<br>label_{wh}&lt;anchor_t \cdot anchor_t<br>$$</p>
</li>
<li><p>标签框的尺寸小于<code>anchor</code>的尺寸，$r&lt;1&#x2F;r$，条件为：<br>$$<br>1&#x2F;r&lt;anchor_t \\<br>\frac{anchor_{wh}}{label_{wh}}&lt;anchor_t \\<br>\frac{anchor_{wh}}{anchor_t} &lt;label_{wh}\\<br>$$</p>
</li>
</ul>
<p>综上可得：<br>$$<br>\frac{anchor_{wh}}{anchor_t} &lt;label_{wh}&lt;anchor_t \cdot anchor_t<br>$$</p>
<p>以输入特征图为480*288，anchor_t &#x3D;4.0为例，标签框在不同分支的分布如下：</p>
<table>
<thead>
<tr>
<th>特征层</th>
<th>anchors (w,h)</th>
<th>分辨率</th>
<th>stride</th>
</tr>
</thead>
<tbody><tr>
<td>P3&#x2F;8</td>
<td>(5,5), (5,11), (10,8)</td>
<td>480×288 &#x2F; 8 &#x3D; 60×36</td>
<td>8</td>
</tr>
<tr>
<td>P4&#x2F;16</td>
<td>(17,14), (12,28), (30,23)</td>
<td>480×288 &#x2F; 16 &#x3D; 30×18</td>
<td>16</td>
</tr>
<tr>
<td>P5&#x2F;32</td>
<td>(33,66), (60,44), (98,108)</td>
<td>480×288 &#x2F; 32 &#x3D; 15×9</td>
<td>32</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>特征层</th>
<th>Anchor (w,h)</th>
<th>标签框最小尺寸</th>
<th>标签框最大尺寸 (anchor_t&#x3D;4)</th>
</tr>
</thead>
<tbody><tr>
<td>P3&#x2F;8</td>
<td>(5,5)</td>
<td>1 × 1</td>
<td>20 × 20</td>
</tr>
<tr>
<td>P3&#x2F;8</td>
<td>(5,11)</td>
<td>1 × 2</td>
<td>20 × 44</td>
</tr>
<tr>
<td>P3&#x2F;8</td>
<td>(10,8)</td>
<td>2 × 2</td>
<td>40 × 32</td>
</tr>
<tr>
<td>P4&#x2F;16</td>
<td>(17,14)</td>
<td>4 × 3</td>
<td>68 × 56</td>
</tr>
<tr>
<td>P4&#x2F;16</td>
<td>(12,28)</td>
<td>3 × 7</td>
<td>48 × 112</td>
</tr>
<tr>
<td>P4&#x2F;16</td>
<td>(30,23)</td>
<td>7 × 5</td>
<td>120 × 92</td>
</tr>
<tr>
<td>P5&#x2F;32</td>
<td>(33,66)</td>
<td>8 × 16</td>
<td>132 × 264</td>
</tr>
<tr>
<td>P5&#x2F;32</td>
<td>(60,44)</td>
<td>15 × 11</td>
<td>240 × 176</td>
</tr>
<tr>
<td>P5&#x2F;32</td>
<td>(98,108)</td>
<td>24 × 27</td>
<td>392 × 432</td>
</tr>
</tbody></table>
<blockquote>
<p>这里的尺寸都是相对于输入图像的尺寸480x288的</p>
</blockquote>
<p>看这个表可以看出，anchor的设置直接决定了哪些分支可以预测什么尺寸的目标，在冻结层进行训练时具有较好的参考意义。</p>
<p><mark><code>t = t[j]</code>为满足各个分支要求的标签框的<code>x,y,w,h </code></mark></p>
<hr>
<h4 id="标签缩放"><a href="#标签缩放" class="headerlink" title="标签缩放"></a>标签缩放</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">build_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># Build targets for compute_loss(), input targets(image,class,x,y,w,h)</span>
        na<span class="token punctuation">,</span> nt <span class="token operator">=</span> self<span class="token punctuation">.</span>na<span class="token punctuation">,</span> targets<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># number of anchors, targets</span>
        tcls<span class="token punctuation">,</span> tbox<span class="token punctuation">,</span> indices<span class="token punctuation">,</span> anch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        gain <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># normalized to gridspace gain</span>
        ai <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>na<span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> nt<span class="token punctuation">)</span>  <span class="token comment"># same as .repeat_interleave(nt)</span>
        targets <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>targets<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span>na<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ai<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># append anchor indices</span>

        g <span class="token operator">=</span> <span class="token number">0.5</span>  <span class="token comment"># bias</span>
        off <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># j,k,l,m</span>
                <span class="token comment"># [1, 1], [1, -1], [-1, 1], [-1, -1],  # jk,jm,lk,lm</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            
          <span class="token comment"># 省略无关代码...</span>

                <span class="token comment"># Offsets</span>
                gxy <span class="token operator">=</span> t<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>  <span class="token comment"># grid xy</span>
                gxi <span class="token operator">=</span> gain<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">-</span> gxy  <span class="token comment"># inverse</span>
                j<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxy <span class="token operator">%</span> <span class="token number">1</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxy <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                l<span class="token punctuation">,</span> m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>gxi <span class="token operator">%</span> <span class="token number">1</span> <span class="token operator">&lt;</span> g<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>gxi <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T
                j <span class="token operator">=</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">,</span> j<span class="token punctuation">,</span> k<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span>
                t <span class="token operator">=</span> t<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span>
                offsets <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>gxy<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">+</span> off<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<ul>
<li>这里标签框的<code>x,y,w,h</code>是相对于特征图而言的，且x,y为相对于<strong>特征图</strong>的左上顶点的偏移量。</li>
</ul>
</blockquote>
<p><code>gxy</code>为标签框的<code>x,y</code>,<code>gxi</code>为标签框的<code>x,y</code>距离右侧和下边缘的距离,因此<code>gxy</code>的小数部分表示的是不足一个<code>gride</code>的部分，如果小数部分小于<code>0.5</code>则认为预测的标签框的坐标距离某个<code>gride</code>的左上顶点比较近，<code>gxi</code>如果大于1，说明标签框的位置坐标距离某个<code>gride</code>的右下顶点比较近。然后将标签狂的坐标向比较近方向扩充一个<code>gride</code>,也就是<code>off</code>指定的四个方法，每个方向的扩展为<code>1</code>个<code>gride</code>。其中<code>gxy &gt; 1</code>约束位置坐标距离左上至少一个<code>gride</code>,<code>gxi &gt; 1</code>约束位置坐标距离右下至少一个<code>gride</code>,这都是为了避免扩展后越界。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">build_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 省略无关代码...</span>
               <span class="token comment"># Define</span>
               bc<span class="token punctuation">,</span> gxy<span class="token punctuation">,</span> gwh<span class="token punctuation">,</span> a <span class="token operator">=</span> t<span class="token punctuation">.</span>chunk<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (image, class), grid xy, grid wh, anchors</span>
               a<span class="token punctuation">,</span> <span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token operator">=</span> a<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bc<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>T  <span class="token comment"># anchors, image, class</span>
               gij <span class="token operator">=</span> <span class="token punctuation">(</span>gxy <span class="token operator">-</span> offsets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
               gi<span class="token punctuation">,</span> gj <span class="token operator">=</span> gij<span class="token punctuation">.</span>T  <span class="token comment"># grid indices</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>torch.chunk(t, 4, dim=1)</code> 沿第 1 维（列方向）把张量 <code>t</code> 划分为 4 段，并把这 4 段分别赋给 <code>bc, gxy, gwh, a</code>。在 YOLO 的上下文里，<code>t</code> 通常每行是 <code>[img, cls, x, y, w, h, anchor_idx]</code>（共 7 列），所以划分后得到：</p>
<ul>
<li><code>bc</code> → 前 2 列：<code>[img, class]</code>，形状 <code>(M,2)</code></li>
<li><code>gxy</code> → 接下 2 列：<code>[x, y]</code>（grid-space 浮点坐标），形状 <code>(M,2)</code></li>
<li><code>gwh</code> → 再接 2 列：<code>[w, h]</code>（grid-space 宽高），形状 <code>(M,2)</code></li>
<li><code>a</code> → 最后一列：<code>[anchor_idx]</code>，形状 <code>(M,1)</code></li>
</ul>
<p>根据上面的分析:</p>
<p><mark><code>gij</code>为满足对应条件的标签框扩展后的整数位置坐标<code>x,y</code>,<code>gi, gj</code>分别为特征图下的<code>gride</code>横纵向索引</mark></p>
<p><mark><code>a</code>为对应的anchor的索引<code>b</code>为对应的图像索引，<code>c</code>为对应的类别索引</mark></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">build_targets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token comment"># 省略无关代码...</span>
	   <span class="token comment"># Append</span>
           indices<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gi<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> shape<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># image, anchor, grid</span>
           tbox<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>gxy <span class="token operator">-</span> gij<span class="token punctuation">,</span> gwh<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># box</span>
           anch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>anchors<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># anchors</span>
           tcls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c<span class="token punctuation">)</span>  <span class="token comment"># class</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的<code>clamp_</code>是为了放置扩展后的坐标超出特征图尺寸的，<code>gxy - gij</code>得到的是在<code>gride</code>尺度下的位置坐标偏移量，即：相对于<code>gxy</code>取整后的那个<code>gride</code>的内部偏移量。因此</p>
<ul>
<li><p><code>indices[0]</code>为标签框对应的图像索引</p>
</li>
<li><p><code>indices[1]</code>为标签框对应的<code>anchor</code>组索引，每组<code>anchor</code>有3中尺寸的框</p>
</li>
<li><p><code>indices[2]</code>为标签框在特征图尺度下的<code>gride</code>纵向索引，即：在第几行</p>
</li>
<li><p><code>indices[3]</code>为标签框在特征图尺度下的<code>gride</code>横向索引，即：在第几列</p>
</li>
<li><p><code>tbox</code>为标签框在特征图尺度下的<code>gride</code>内部偏移量和尺寸</p>
</li>
<li><p><code>anch</code>为标签框对应的anchor</p>
</li>
<li><p><code>tcls</code>为标签框对应类别索引</p>
</li>
</ul>
<h4 id="哪些box参与了box-loss计算？"><a href="#哪些box参与了box-loss计算？" class="headerlink" title="哪些box参与了box loss计算？"></a>哪些box参与了box loss计算？</h4><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># predictions, targets</span>
    lcls <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># class loss</span>
    lbox <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># box loss</span>
    lobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># object loss</span>
    tcls<span class="token punctuation">,</span> tbox<span class="token punctuation">,</span> indices<span class="token punctuation">,</span> anchors <span class="token operator">=</span> self<span class="token punctuation">.</span>build_targets<span class="token punctuation">(</span>p<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>  <span class="token comment"># targets</span>

    <span class="token comment"># Losses</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> pi <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># layer index, layer predictions</span>
        b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># image, anchor, gridy, gridx</span>
        tobj <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>pi<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>pi<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># target obj</span>

        n <span class="token operator">=</span> b<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># number of targets</span>
        <span class="token keyword">if</span> n<span class="token punctuation">:</span>
            <span class="token comment"># pxy, pwh, _, pcls = pi[b, a, gj, gi].tensor_split((2, 4, 5), dim=1)  # faster, requires torch 1.8.0</span>
            pxy<span class="token punctuation">,</span> pwh<span class="token punctuation">,</span> _<span class="token punctuation">,</span> pcls <span class="token operator">=</span> pi<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>nc<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># target-subset of predictions</span>
            <span class="token comment"># 省略无关代码...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>图像的标签框有$N$个，满足分支$i$的标签框为$N_i$,且每次推理有<code>batch size</code>个图像，这些标签框都是哪些图像的标签框需要在<code>b</code>中指明，因此：</p>
<ul>
<li><p><code>n = b.shape[0]</code>表示这个分支有多少了标签框参与<code>box loss</code>计算,且<code>b, a, gj, gi</code>的<code>.shape[0]</code>是相等的</p>
</li>
<li><p><code>indices</code>定义为正样本集合，所谓的正样本就是各个输出分支对应的<strong>满足尺寸阈值</strong>的标签框的信息：对应的图像索引，<code>anchor</code>索引，<code>grid</code>索引</p>
</li>
<li><p><code>pi[b, a, gj, gi]</code>提取对应输出分支的正样本标签信息，<code>b</code>是第几张图像，<code>a</code>为第几组<code>anchor</code>，<code>(gj,gi)</code>为第几个<code>gride</code>，因此<code>pi[b, a, gj, gi]</code>得到的框的个数和对应分支的正样本中框的个数是相等的，那么误检的框不在标签中，更不在正样本中，故：误检框的box loss是不计算的。而漏检的框在标签框中是存在的，在对应的分支的正样本中也是存在的，因此漏检框的box loss是计算的。</p>
<table>
<thead>
<tr>
<th align="center">loss</th>
<th align="center">漏检</th>
<th align="center">误检</th>
<th align="center">precision</th>
<th align="center">recall</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>box loss</strong></td>
<td align="center">✔️</td>
<td align="center">❌</td>
<td align="center">❌</td>
<td align="center">✔</td>
</tr>
</tbody></table>
</li>
</ul>
<p><mark>只有正样本会被计算box loss</mark></p>
<h3 id="obj-loss"><a href="#obj-loss" class="headerlink" title="obj_loss"></a>obj_loss</h3><p>- </p>
<p>现在来看obj_loss如何计算，源码中的计算公式如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">self<span class="token punctuation">.</span>balance <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">3</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.4</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>m<span class="token punctuation">.</span>nl<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">4.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.06</span><span class="token punctuation">,</span> <span class="token number">0.02</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># P3-P7</span>
<span class="token comment"># 省略无关代码 ...</span>
tobj<span class="token punctuation">[</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> gj<span class="token punctuation">,</span> gi<span class="token punctuation">]</span> <span class="token operator">=</span> iou
<span class="token comment"># 省略无关代码 ...</span>
obji <span class="token operator">=</span> self<span class="token punctuation">.</span>BCEobj<span class="token punctuation">(</span>pi<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tobj<span class="token punctuation">)</span>
lobj <span class="token operator">+=</span> obji <span class="token operator">*</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># obj loss</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中tobj为根据Iou得到的标签中对应的各个gride是否有目标的0-1矩阵，iou大于0说明对应标签框的位置有预测目标框，iou&#x3D;0的位置说明对应标签框的位置没有预测目标框，就是漏检。这里作为交叉熵损失的$y$进行输入。</p>
<p><code>pi[..., 4]</code>表示box的位置置信度，<code>pi</code>中存储的元素如下所示：</p>
<ul>
<li><code>pi[..., 0:4]</code> → 边界框 (bbox) 的偏移量或参数</li>
<li><code>pi[..., 4]</code> → <strong>objectness (有无物体的置信度)</strong></li>
<li><code>pi[..., 5:]</code> → 各类别的分数</li>
</ul>
<p>因此这里的obji就是位置预测分数和标签的二元交叉熵损失。然后进行加权累加：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">lobj <span class="token operator">+=</span> obji <span class="token operator">*</span> self<span class="token punctuation">.</span>balance<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token comment"># obj loss</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里可以看出漏报和误报在这个损失中都有体现，因为<code>pi</code>中存储了所有的预测结果，<code>tobj</code>中存储了所有正样本的iou，其他框(负样本)的iou均为0，然后转换为各个gride的预测和标签值，如果标签与某个gride有交集这个<code>gride</code>的tobj就是被置1，对于<code>pi</code>预测的是各个gride的目标框的置信度，因此这个损失不仅考虑匹配成功的预测结果吗，还会考虑漏报和误报。</p>
<p><code>balance</code>为不同检测层的 <strong>平衡系数</strong>，手动调节各层 obj 损失的贡献比例，设置这一调整的原因如下：</p>
<ul>
<li><p>小目标层 (P3&#x2F;8) → feature map 大，grid 数量多 → obj 损失自然偏大。</p>
</li>
<li><p>大目标层 (P5&#x2F;32) → feature map 小，grid 数量少 → obj 损失自然偏小。</p>
</li>
<li><p>如果直接相加：小目标层会“压过”大目标层。</p>
</li>
</ul>
<p>所以作者引入 <code>balance[i]</code>，对不同层加权，使 obj 损失更加平衡。在 <code>loss.py</code> 里，常见的 <code>self.balance</code> 初始是：</p>
<pre class="line-numbers language-none"><code class="language-none">self.balance &#x3D; [4.0, 1.0, 0.4]  # 对应 P3, P4, P5<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>意思是：</p>
<ul>
<li><strong>P3 (小目标层)</strong> → 权重大 (×4.0)，因为小目标检测难，需要更关注。</li>
<li><strong>P4 (中目标层)</strong> → 权重标准 (×1.0)。</li>
<li><strong>P5 (大目标层)</strong> → 权重小 (×0.4)，避免大目标层损失过度干扰训练</li>
</ul>
<h3 id="class-loss-1"><a href="#class-loss-1" class="headerlink" title="class loss"></a>class loss</h3><p>类别的损失同样使用的是二元交叉熵损失，方法类似，直接看代码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">if</span> self<span class="token punctuation">.</span>nc <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># cls loss (only if multiple classes)</span>
                   t <span class="token operator">=</span> torch<span class="token punctuation">.</span>full_like<span class="token punctuation">(</span>pcls<span class="token punctuation">,</span> self<span class="token punctuation">.</span>cn<span class="token punctuation">,</span> device<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>  <span class="token comment"># targets</span>
                   t<span class="token punctuation">[</span><span class="token builtin">range</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">,</span> tcls<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>cp
                   lcls <span class="token operator">+=</span> self<span class="token punctuation">.</span>BCEcls<span class="token punctuation">(</span>pcls<span class="token punctuation">,</span> t<span class="token punctuation">)</span>  <span class="token comment"># BCE</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>不同是这里是有条件的，对于单类的目标不计算类别损失，这是为什么？我们来分析一下：</p>
<p>对于boss的BCEobj损失和类别的BCEcls损失输入的y都是根据标签进行转换的0,1矩阵，两个loss的标签值是相同的，BCEobj使用的预测<code>pi[..., 4]</code>进行计算的，而BCEcls是使用<code>pi[..., 5]</code>进行计算的，也就是说此完全可以使用一个共同的分数同时预测box的置信度和类别的置信度：</p>
<p>单类目标检测中保留 BCEcls 有什么影响：</p>
<ul>
<li><p><strong>冗余监督</strong>：<br> BCEcls 和 BCEobj 本质上学的是同一个东西，增加一个 BCEcls 并不会增加信息量，反而会让模型在两个分支上分散梯度。</p>
</li>
<li><p><strong>梯度冲突</strong>：<br> BCEobj 和 BCEcls 都在学习“是否有目标”，可能会出现一个分支学习更快，另一个分支被迫去拟合同样的分布 → 有时会造成收敛更慢。</p>
</li>
<li><p><strong>推理时仍然合并</strong>：<br> YOLO 最终的 score 是<br>$$<br>\text{score} &#x3D; \text{obj} \times \text{cls}<br>$$<br>单类时就是<br>$$<br>\text{score} &#x3D; \text{obj} \times \text{1类概率}<br>$$<br>如果 obj&#x3D;0.9，cls&#x3D;0.9，最终还是 0.81 → 实际上比分开时更低，不一定“更准确”，反而可能错过一些框。</p>
</li>
</ul>
<p>也就是说，如果单类目标检测中保留 BCEcls 只要能保证训练的收敛，最终使用$\text{score} &#x3D; \text{obj} \times \text{cls}$计算预测分数，此时预测精度更高， 这样相当于“二次确认”，只要训练充分收敛，最终的预测精度会更高，尤其是减少假阳性。同时也可以对正样本和负样本的损失比例进行调整，使用<code>obj_pw</code>超参数配置正样本的损失计算系数，设置<code>obj_pw=1.0</code>意思时正负样本损失同等对比，<code>obj_pw&gt;1.0</code>则说明更看重正样本的损失。</p>
<h3 id="loss"><a href="#loss" class="headerlink" title="loss"></a>loss</h3><p>最终计算的loss是加权的结果：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">lbox <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span>
lobj <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'obj'</span><span class="token punctuation">]</span>
lcls <span class="token operator">*=</span> self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token string">'cls'</span><span class="token punctuation">]</span>
bs <span class="token operator">=</span> tobj<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># batch size</span>

<span class="token keyword">return</span> <span class="token punctuation">(</span>lbox <span class="token operator">+</span> lobj <span class="token operator">+</span> lcls<span class="token punctuation">)</span> <span class="token operator">*</span> bs<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>lbox<span class="token punctuation">,</span> lobj<span class="token punctuation">,</span> lcls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中:</p>
<ul>
<li>训练的超参数来自训练时的<code>--hyp</code>配置的超参数<code>yml</code>文件,默认使用<code>data/hyps/hyp.scratch-high.yaml</code>文件</li>
<li>$*bs$是因为计算的时候使用的都是均值，这里为了得到所有图像的损失<ul>
<li>如果 batch size 固定，乘或不乘 不会改变训练方向&#x2F;收敛趋势</li>
<li>乘上 batch size 只是改变了 loss 和梯度的绝对值大小，需要对应调整学习率或优化器参数</li>
</ul>
</li>
</ul>
<h4 id="权重配置"><a href="#权重配置" class="headerlink" title="权重配置"></a>权重配置</h4><table>
<thead>
<tr>
<th>训练情景</th>
<th>resume</th>
<th>其它</th>
</tr>
</thead>
<tbody><tr>
<td>超参数配置文件</td>
<td>历史训练文件夹中的<code>opt.yaml</code></td>
<td>–hyp 配置的超参数配置文件</td>
</tr>
</tbody></table>
<p>根据训练的情景不同，<code>train.py</code>会从不同的配置文件中加载超参数，这里以下面的配置为示例分析loss的权重配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">box</span><span class="token punctuation">:</span> <span class="token number">0.05</span>
<span class="token key atrule">cls</span><span class="token punctuation">:</span> <span class="token number">0.3</span>
<span class="token key atrule">cls_pw</span><span class="token punctuation">:</span> <span class="token number">1.0</span>
<span class="token key atrule">obj</span><span class="token punctuation">:</span> <span class="token number">1.5</span>
<span class="token key atrule">obj_pw</span><span class="token punctuation">:</span> <span class="token number">1.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上述配置为<code>.yaml</code>文件中的配置参数，<code>train.py</code>加载这些参数后会对其进行动态缩放处理，目的是让不同网络结构、数据集规模、输入尺寸下，损失函数各部分的权重保持在一个合理的相对平衡。：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>hyp<span class="token punctuation">,</span> opt<span class="token punctuation">,</span> device<span class="token punctuation">,</span> callbacks<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token comment">#省略无关代码...</span>
    hyp<span class="token punctuation">[</span><span class="token string">'box'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token number">3</span> <span class="token operator">/</span> nl  <span class="token comment"># scale to layers</span>
    hyp<span class="token punctuation">[</span><span class="token string">'cls'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> nc <span class="token operator">/</span> <span class="token number">80</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> nl  <span class="token comment"># scale to classes and layers</span>
    hyp<span class="token punctuation">[</span><span class="token string">'obj'</span><span class="token punctuation">]</span> <span class="token operator">*=</span> <span class="token punctuation">(</span>imgsz <span class="token operator">/</span> <span class="token number">640</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">/</span> nl  <span class="token comment"># scale to image size and layers</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>这里可以看到读取的三个超参数都进行了<code>3/nl</code>的动态缩放，<code>nl</code>指的是输出分支的个数，一般为3。因为在计算<code>loss</code>的时候是对每个分支的loss求和的，这里为了平衡，都进行了统一的尺度的动态缩放。这样不管是多少个分支都会相对稳定。</p>
<blockquote>
<p>这里有点懵，其实这就是为了平衡损失的计算的，避免输出分支的增加或类别的增加导致某个类型的损失过大或过小。官方超参数调优时，是在 <strong>3 层检测 + 640 输入 + 80 类 COCO</strong> 上做的，所以这里都是为了和官方的超参数对齐的。</p>
</blockquote>
</li>
<li><p>对于<code>box loss</code>，如果分支小于3，为了不至于损失权重过小，这里进行损失权重的增大；分支大于3也不至于太大，这里进行缩小。因此这里设置的动态缩放为<code>3/nl</code>。</p>
</li>
<li><p>对于<code>class loss</code>，如果类别数较少时，分类任务相对简单，需要降低类别损失的权重；类别数较多时，分类任务比较困难，可以适当增加类别损失的权重，因此，动态权重设置为<code>nc/80</code>。同时类别损失也不应受到分支数的变化而发生失衡，因此，这里设置的动态缩放为<code>3/nl</code>。</p>
</li>
<li><p>对于<code>obj loss</code>，如果输入图像增大的情况下，由于正样本的数量不会增加，但占据的<code>gride</code>会增加，而负样本占据的<code>gride</code>更多，因此输入图像增大的情况下，<code>obj loss</code>会突增，这里为了平衡总损失，设置动态系数为<code>(imgsz / 640) ** 2</code>。同时<code>obj loss</code>也不应受到分支数的变化而发生失衡，因此，这里设置的动态缩放为<code>3/nl</code>。</p>
</li>
</ul>
<p>以经典的3分支输出为例，输入图像为480*288，经过缩放后的超参数如下：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">box</span><span class="token punctuation">:</span> <span class="token number">0.05</span>
<span class="token key atrule">cls</span><span class="token punctuation">:</span> <span class="token number">0.00375</span>
<span class="token key atrule">cls_pw</span><span class="token punctuation">:</span> <span class="token number">1.0</span>
<span class="token key atrule">obj</span><span class="token punctuation">:</span> <span class="token number">0.84375</span>
<span class="token key atrule">obj_pw</span><span class="token punctuation">:</span> <span class="token number">1.0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="IOU-交并比损失"><a href="#IOU-交并比损失" class="headerlink" title="IOU(交并比损失)"></a>IOU(交并比损失)</h2><p>这里使用了<code>bbox_iou()</code>函数进行iou计算，详细内容如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># ultralytics/utils/metrics.py</span>
<span class="token keyword">def</span> <span class="token function">bbox_iou</span><span class="token punctuation">(</span><span class="token comment"># ......省略无关代码......)</span>
	<span class="token comment"># ......省略无关代码......</span>
    <span class="token comment"># IoU</span>
    iou <span class="token operator">=</span> inter <span class="token operator">/</span> union
    <span class="token keyword">if</span> CIoU <span class="token keyword">or</span> DIoU <span class="token keyword">or</span> GIoU<span class="token punctuation">:</span>
        cw <span class="token operator">=</span> b1_x2<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>b2_x2<span class="token punctuation">)</span> <span class="token operator">-</span> b1_x1<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>b2_x1<span class="token punctuation">)</span>  <span class="token comment"># convex (smallest enclosing box) width</span>
        ch <span class="token operator">=</span> b1_y2<span class="token punctuation">.</span>maximum<span class="token punctuation">(</span>b2_y2<span class="token punctuation">)</span> <span class="token operator">-</span> b1_y1<span class="token punctuation">.</span>minimum<span class="token punctuation">(</span>b2_y1<span class="token punctuation">)</span>  <span class="token comment"># convex height</span>
        <span class="token keyword">if</span> CIoU <span class="token keyword">or</span> DIoU<span class="token punctuation">:</span>  <span class="token comment"># Distance or Complete IoU https://arxiv.org/abs/1911.08287v1</span>
            c2 <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> ch<span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> eps  <span class="token comment"># convex diagonal squared</span>
            rho2 <span class="token operator">=</span> <span class="token punctuation">(</span>
                <span class="token punctuation">(</span>b2_x1 <span class="token operator">+</span> b2_x2 <span class="token operator">-</span> b1_x1 <span class="token operator">-</span> b1_x2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>b2_y1 <span class="token operator">+</span> b2_y2 <span class="token operator">-</span> b1_y1 <span class="token operator">-</span> b1_y2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">4</span>  <span class="token comment"># center dist**2</span>
            <span class="token keyword">if</span> CIoU<span class="token punctuation">:</span>  <span class="token comment"># https://github.com/Zzh-tju/DIoU-SSD-pytorch/blob/master/utils/box/box_utils.py#L47</span>
                v <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">/</span> math<span class="token punctuation">.</span>pi<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>w2 <span class="token operator">/</span> h2<span class="token punctuation">)</span><span class="token punctuation">.</span>atan<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>w1 <span class="token operator">/</span> h1<span class="token punctuation">)</span><span class="token punctuation">.</span>atan<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    alpha <span class="token operator">=</span> v <span class="token operator">/</span> <span class="token punctuation">(</span>v <span class="token operator">-</span> iou <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> eps<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> iou <span class="token operator">-</span> <span class="token punctuation">(</span>rho2 <span class="token operator">/</span> c2 <span class="token operator">+</span> v <span class="token operator">*</span> alpha<span class="token punctuation">)</span>  <span class="token comment"># CIoU</span>
            <span class="token keyword">return</span> iou <span class="token operator">-</span> rho2 <span class="token operator">/</span> c2  <span class="token comment"># DIoU</span>
        c_area <span class="token operator">=</span> cw <span class="token operator">*</span> ch <span class="token operator">+</span> eps  <span class="token comment"># convex area</span>
        <span class="token keyword">return</span> iou <span class="token operator">-</span> <span class="token punctuation">(</span>c_area <span class="token operator">-</span> union<span class="token punctuation">)</span> <span class="token operator">/</span> c_area  <span class="token comment"># GIoU https://arxiv.org/pdf/1902.09630.pdf</span>
    <span class="token keyword">return</span> iou  <span class="token comment"># IoU</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<ul>
<li><strong>IoU（Intersection over Union）交并比</strong></li>
</ul>
<p>公式：<br>$$<br>\text{IoU} &#x3D; \frac{\text{Area}<em>{\text{intersection}}}{\text{Area}</em>{\text{union}}}<br>$$<br>表示预测框和真实框重叠区域占联合区域的比例，范围 $[0, 1]$。</p>
<ul>
<li><strong>GIoU（Generalized IoU）</strong></li>
</ul>
<p>改进目标： 当预测框与真实框没有重叠时，IoU 为 0，无法反映预测框相对位置。GIoU 引入了最小闭包框（convex hull）进行补偿。</p>
<p>公式：<br>$$<br>\text{GIoU} &#x3D; \text{IoU} - \frac{|\text{C} - (\text{A} \cup \text{B})|}{|\text{C}|}<br>$$</p>
<ul>
<li>$\text{C}$：包含预测框 A 和真实框 B 的最小闭包矩形面积</li>
<li>$\text{A} \cup \text{B}$：预测框与真实框的并集</li>
</ul>
<p>范围： $[-1, 1]$，值越大说明预测越准。</p>
<ul>
<li><strong>DIoU（Distance IoU）</strong></li>
</ul>
<p>改进目标： 考虑中心点之间的距离。</p>
<p>公式：<br>$$<br>\text{DIoU} &#x3D; \text{IoU} - \frac{\rho^2(\mathbf{b}, \mathbf{b}^{gt})}{c^2}<br>$$</p>
<ul>
<li>$\rho(\cdot)$：预测框中心点和真实框中心点之间的欧几里得距离</li>
<li>$c$：包含两个框的最小闭包矩形的对角线长度</li>
</ul>
<p>特点： 既考虑重叠面积，又考虑中心点远近。</p>
<ul>
<li><strong>CIoU（Complete IoU）</strong></li>
</ul>
<p>改进目标： 进一步引入了宽高比一致性。</p>
<p>公式：<br>$$<br>\text{CIoU} &#x3D; \text{IoU} - \frac{\rho^2(\mathbf{b}, \mathbf{b}^{gt})}{c^2} - \alpha v<br>$$<br>其中：</p>
<ul>
<li>$v &#x3D; \frac{4}{\pi^2} \left( \arctan\left(\frac{w^{gt}}{h^{gt}}\right) - \arctan\left(\frac{w}{h}\right) \right)^2$：宽高比差异</li>
<li>$\alpha &#x3D; \frac{v}{1 - \text{IoU} + v}$：权重因子</li>
</ul>
<p>特点： 同时考虑重叠面积、中心点距离和长宽比差异。</p>
<p><strong>在v8DetectionLoss方法中默认使用了CIoU方法对IoU进行计算</strong>，具体计算方法如下：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python">iou <span class="token operator">=</span> bbox_iou<span class="token punctuation">(</span>pred_bboxes<span class="token punctuation">[</span>fg_mask<span class="token punctuation">]</span><span class="token punctuation">,</span> target_bboxes<span class="token punctuation">[</span>fg_mask<span class="token punctuation">]</span><span class="token punctuation">,</span> xywh<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> CIoU<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
loss_iou <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> iou<span class="token punctuation">)</span> <span class="token operator">*</span> weight<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> target_scores_sum<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里的权重是指<code>TaskAlignedAssigner</code>算法计算的匹配权重(后面详细解释该方法)，<code>target_scores_sum</code>为所有前景目标的匹配分数之和，这里是进行了归一化，这样计算损失是为了避免训练时梯度消失和有利于训练收敛：</p>
<ul>
<li>高分框惩罚更大，影响更强</li>
<li>所有正样本的损失进行归一平均，防止不同 batch 样本不均衡导致训练不稳定</li>
<li>另一方面<code>1.0 - iou</code>是一个张量，里面存储了这个bach_size中所有框的iou损失，如果不进行归一化，无法进行损失回传且loss的量级不稳定</li>
</ul>
<h2 id="BCE-loos-二元交叉熵损失"><a href="#BCE-loos-二元交叉熵损失" class="headerlink" title="BCE loos(二元交叉熵损失)"></a>BCE loos(二元交叉熵损失)</h2><p>首先看下什么是二元交叉熵损失：</p>
<p><strong><code>nn.BCEWithLogitsLoss</code></strong></p>
<ul>
<li><p>这是 PyTorch 提供的 <strong>带 sigmoid 的二元交叉熵损失函数</strong>。</p>
</li>
<li><p>公式等价于：<br>$$<br>BCE(x, y) &#x3D; - \big[ y \cdot \log(\sigma(x)) + (1-y)\cdot\log(1-\sigma(x)) \big]<br>$$<br>其中 $\sigma(x)&#x3D;\frac{1}{1+e^{-x}}$ 是 sigmoid。$\sigma(x)$就是预测分数</p>
<p>当y&#x3D;0时：<br>$$<br>BCE(x, y) &#x3D; - log(1-\sigma(x))<br>$$</p>
<p>当y&#x3D;1时：<br>$$<br>BCE(x, 1) &#x3D; - \log(\sigma(x))<br>$$</p>
</li>
<li><p><strong>$y$</strong></p>
<ul>
<li>真实标签 (ground truth)，这里的标签是转换后的标签</li>
<li>只能取 <code>0</code> 或 <code>1</code></li>
<li>0 → 表示“负样本”</li>
<li>1 → 表示“正样本”</li>
</ul>
</li>
<li><p><strong>$x$</strong></p>
<ul>
<li>模型预测值，经过sigmoid后转换为概率</li>
<li>范围为任意的网络输出</li>
</ul>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/geiyiren/MyBlogImage1/yolo%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E7%AE%97%E6%B3%95%E4%B9%8B%E6%8D%9F%E5%A4%B1%E8%AE%A1%E7%AE%97/image-20250827202928632.png" alt="image-20250827202928632"></p>
<p>根据曲线可以看出：</p>
<ul>
<li>如果标签中给的gride无目标，即y&#x3D;0时，预测的分数越大，损失越大；这就会对误报进行惩罚</li>
<li>如果标签中给的gride有目标，即y&#x3D;1时，预测的分数越大，损失越小；这就会对漏报进行惩罚</li>
</ul>
<h2 id="DFL-loss-分布式焦点损失"><a href="#DFL-loss-分布式焦点损失" class="headerlink" title="DFL loss(分布式焦点损失)"></a>DFL loss(分布式焦点损失)</h2><p>DFL损失，全称为Distribution Focal Loss(焦点分布损失)：它主要应用在目标检测任务中的边界框回归（bounding box regression）过程。 DFL损失的主要作用是用于校正模型在预测物体边界框时的误差，优化后的效果可以在一定程度上针对有些模糊或者焦点不集中的图片提升对象检测的精度。 在训练过程中DFL损失越低，说明模型在预测边界框方面的性能越好。<strong>DFL损失的计算方法由<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/2006.04388">论文</a>提出。</strong></p>
<ul>
<li><strong>DFL和IoULoss的区别</strong></li>
</ul>
<table>
<thead>
<tr>
<th>对比点</th>
<th>DFL（距离精度）</th>
<th>IoU Loss（重叠度）</th>
</tr>
</thead>
<tbody><tr>
<td><strong>关注对象</strong></td>
<td>每个方向的偏移量（ltrb）</td>
<td>整体框与 GT 框的 IoU</td>
</tr>
<tr>
<td><strong>误差表现</strong></td>
<td>数值上与 GT 偏差</td>
<td>重叠面积比例</td>
</tr>
<tr>
<td><strong>可解释性</strong></td>
<td>“我左边预测错了 2 像素”</td>
<td>“我框和目标只有 60% 重叠”</td>
</tr>
<tr>
<td><strong>优化引导方向</strong></td>
<td>优化边界精度、贴近真实距离</td>
<td>优化整体框覆盖目标</td>
</tr>
<tr>
<td><strong>结果解码方式</strong></td>
<td>解码后再计算框</td>
<td>已解码框直接参与计算</td>
</tr>
</tbody></table>
<blockquote>
<p> 预测框的anchor_point只有落在标签框的区域内才会进行Iou损失和DFL损失计算</p>
</blockquote>
<p>DFL损失计算的步骤如下：</p>
<ul>
<li>计算anchor_point和标签框边界的距离，得到$ltrb &#x3D; [左距离，顶距离，右距离，下距离]$</li>
<li>对这些距离进行限制，强制限制在(0, reg_max - 0.01)范围内</li>
<li>计算左右 bin 索引和权重</li>
<li>计算交叉熵损失</li>
</ul>
<p>计算公式如下所示:<br>$$<br>\begin{array}{c}<br>\mathrm{DFL}(p,t)&#x3D;w_l\cdot\mathrm{CE}(p,t_l)+w_r\cdot\mathrm{CE}(p,t_r)<br>\end{array}<br>$$<br>其中：</p>
<ul>
<li>$t$：目标边界框的连续坐标值（如偏移量）</li>
<li>$t_l &#x3D; \lfloor t \rfloor$：目标值左侧的整数 bin 索引</li>
<li>$t_r &#x3D; t_l + 1$：目标值右侧的整数 bin 索引</li>
<li>$w_l &#x3D; t_r - t$：左侧 bin 的权重</li>
<li>$w_r &#x3D; t - t_l &#x3D; 1 - w_l$：右侧 bin 的权重</li>
<li>$p$：模型预测的离散概率分布（长度为 $reg_max + 1$）</li>
<li>$\text{CE}(p, y) &#x3D; -\log(p_y)$：交叉熵损失（当 $p$ 为概率）或标准交叉熵形式（当 $p$ 为 logits）</li>
</ul>
<p>举个例子:</p>
<p>假设 <code>reg_max=5</code>，GT <code>target=2.6</code>，<code>pred_dist=[0.1, 0.1, 0.2, 0.3, 0.3]</code>，则：</p>
<ul>
<li><p><code>tl=2</code>, <code>tr=3</code></p>
</li>
<li><p><code>wl=0.4</code>, <code>wr=0.6</code></p>
<blockquote>
<p>40% 属于桶 2</p>
<p>60% 属于桶 3</p>
</blockquote>
</li>
<li><p>loss &#x3D; 0.4 × CrossEntropy(pred, 2) + 0.6 × CrossEntropy(pred, 3)</p>
</li>
</ul>
<p><code>pred_dist</code> 是模型输出的 <strong>分布式回归预测</strong>，即：<strong>每个 bbox 边界（left&#x2F;top&#x2F;right&#x2F;bottom）对某个离散距离桶的概率分布预测。</strong></p>
<p>DFLoss的实现程序如下所示:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment">#ultralytics/utils/loss.py</span>

<span class="token keyword">class</span> <span class="token class-name">DFLoss</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Criterion class for computing Distribution Focal Loss (DFL)."""</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> reg_max<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Initialize the DFL module with regularization maximum."""</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>reg_max <span class="token operator">=</span> reg_max
<span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pred_dist<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> target<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Return sum of left and right DFL losses from https://ieeexplore.ieee.org/document/9792391."""</span>
    target <span class="token operator">=</span> target<span class="token punctuation">.</span>clamp_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>reg_max <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">0.01</span><span class="token punctuation">)</span>
    tl <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># target left</span>
    tr <span class="token operator">=</span> tl <span class="token operator">+</span> <span class="token number">1</span>  <span class="token comment"># target right</span>
    wl <span class="token operator">=</span> tr <span class="token operator">-</span> target  <span class="token comment"># weight left</span>
    wr <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> wl  <span class="token comment"># weight right</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>pred_dist<span class="token punctuation">,</span> tl<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>tl<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">*</span> wl
        <span class="token operator">+</span> F<span class="token punctuation">.</span>cross_entropy<span class="token punctuation">(</span>pred_dist<span class="token punctuation">,</span> tr<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reduction<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>tl<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">*</span> wr
    <span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
































                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">geiyiren</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://geiyiren.github.io/2025/07/23/yolo-mu-biao-jian-ce-suan-fa-zhi-sun-shi-ji-suan/">https://geiyiren.github.io/2025/07/23/yolo-mu-biao-jian-ce-suan-fa-zhi-sun-shi-ji-suan/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">geiyiren</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/yolo/">
                                    <span class="chip bg-color">yolo</span>
                                </a>
                            
                                <a href="/tags/loss/">
                                    <span class="chip bg-color">loss</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="wechat" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/07/24/mei-ri-ji-hua-2025q3/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/medias/featureimages/7.jpg" class="responsive-img" alt="每日计划-2025Q3">
                        
                        <span class="card-title">每日计划-2025Q3</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            每日计划
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-07-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%AF%8F%E6%97%A5%E8%AE%A1%E5%88%92/" class="post-category">
                                    每日计划
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%AF%8F%E6%97%A5%E8%AE%A1%E5%88%92/">
                        <span class="chip bg-color">每日计划</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/07/21/ti-du-you-hua-qi-zong-jie-yu-fen-xi/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/medias/featureimages/21.jpg" class="responsive-img" alt="梯度优化器总结与分析">
                        
                        <span class="card-title">梯度优化器总结与分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            梯度优化器总结与分析
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-07-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%A2%AF%E5%BA%A6%E4%BC%98%E5%8C%96%E5%99%A8/" class="post-category">
                                    梯度优化器
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%A2%AF%E5%BA%A6%E4%BC%98%E5%8C%96%E5%99%A8/">
                        <span class="chip bg-color">梯度优化器</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: geiyiren<br />'
            + '文章作者: geiyiren<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。详细内容请访问https://geiyiren.github.io';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/prism/prism.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>

<!--  -->



    

<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>



    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2025</span>
            
            <a href="/about" target="_blank">geiyiren</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/geiyiren" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:geiyiren@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="/medias/geiyiren.jpg" class="tooltipped" target="_blank" data-tooltip="关注我的公众号" data-position="top" data-delay="50">
        <i class="fab fa-weixin"></i>
    </a>











</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/others/star.js"><\/script>');
            }
        </script>
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="https://cdn.jsdelivr.net/gh/geiyiren/geiyiren.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
